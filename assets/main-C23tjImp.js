const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./vendor-DxCmb_fS.js","./react-vendor-CJjjzYqR.js","./vendor-B1yS63vA.css"])))=>i.map(i=>d[i]);
import{b as e,j as t,P as r,T as n,d as o,S as s,e as i,f as a,h as l,i as c,k as d,l as u,r as h,m as g,B as p,I as m,n as f,o as x,p as b,F as w,q as v,s as y,t as j,u as C,L as S,V as k,v as E,w as A,x as M,y as I,z as R,A as T,C as P,D,G as L,E as z,H as U,J as _,K as $,M as O,N as F,O as B,Q as N,U as W,W as H,X as V,Y as G,Z as q,_ as K,$ as X,a0 as J,a1 as Y,a2 as Q,a3 as Z,a4 as ee,a5 as te,a6 as re,a7 as ne,a8 as oe,a9 as se,aa as ie,ab as ae,ac as le,ad as ce,ae as de,af as ue,ag as he,ah as ge,ai as pe,aj as me,ak as fe,al as xe,am as be,an as we,ao as ve,ap as ye,aq as je,ar as Ce,as as Se,at as ke,au as Ee,av as Ae,aw as Me,ax as Ie,ay as Re,az as Te,aA as Pe,aB as De,aC as Le,aD as ze,aE as Ue,aF as _e,aG as $e,aH as Oe,aI as Fe,aJ as Be,aK as Ne,aL as We,aM as He,aN as Ve,aO as Ge,aP as qe,aQ as Ke,aR as Xe,aS as Je,aT as Ye,aU as Qe,aV as Ze,aW as et,aX as tt,aY as rt,aZ as nt,a_ as ot,a$ as st,b0 as it,b1 as at,b2 as lt,b3 as ct,b4 as dt,b5 as ut,b6 as ht,b7 as gt,b8 as pt,b9 as mt,ba as ft,bb as xt,bc as bt,bd as wt,be as vt,bf as yt,bg as jt,bh as Ct,bi as St,bj as kt,bk as Et,bl as At,bm as Mt,bn as It,bo as Rt,bp as Tt,bq as Pt,br as Dt,bs as Lt,bt as zt,bu as Ut,bv as _t,bw as $t,bx as Ot,by as Ft,bz as Bt}from"./react-vendor-CJjjzYqR.js";import{at as Nt,au as Wt,av as Ht,aw as Vt,ax as Gt,ay as qt,az as Kt,aA as Xt,aB as Jt,aC as Yt}from"./vendor-DxCmb_fS.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const Qt={container:{position:"relative",width:"100%",height:"100%",overflow:"hidden",pointerEvents:"auto"},image:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",objectFit:"cover",zIndex:1},video:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",objectFit:"cover",zIndex:1,transform:"scaleX(-1)"}},Zt={container:{position:"relative",width:"100%",height:"100%",zIndex:"1",pointerEvents:"auto"}},er={container:{position:"absolute",bottom:"30px",left:"50%",transform:"translateX(-50%)",minWidth:"60%",maxWidth:"95%",zIndex:2},text:{color:"white",fontSize:"1.5rem",textAlign:"center",lineHeight:"1.4",whiteSpace:"pre-wrap",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"}},tr=e({placement:"top-end",pauseOnPageIdle:!0,max:5});function rr(){return t.jsx(r,{children:t.jsx(n,{toaster:tr,insetInline:{mdDown:"4"},children:e=>t.jsxs(o,{width:{md:"sm"},children:["loading"===e.type?t.jsx(s,{size:"sm",color:"blue.solid"}):t.jsx(i,{}),t.jsxs(a,{gap:"1",flex:"1",maxWidth:"100%",children:[e.title&&t.jsx(l,{children:e.title}),e.description&&t.jsx(c,{children:e.description})]}),e.action&&t.jsx(d,{children:e.action.label}),e.meta?.closable&&t.jsx(u,{})]})})})}const nr={width:320,height:240},or=h.createContext(null);function sr({children:e}){const[r,n]=h.useState(!1),[o,s]=h.useState(!1),[i,a]=h.useState(nr),l=h.useRef(null),c=h.useRef(null),d=h.useRef(null),u=h.useCallback((async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API is not supported on this device");const e=await navigator.mediaDevices.enumerateDevices();if(!e.some((e=>"videoinput"===e.kind)))throw new Error("No camera found on this device");const t=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:i.width},height:{ideal:i.height}}});l.current=t,d.current&&(d.current.srcObject=t),n(!0)}catch(e){throw console.error("Failed to start camera:",e),tr.create({title:`Failed to start camera: ${e}`,type:"error",duration:2e3}),e}}),[i]),g=h.useCallback((()=>{l.current&&(l.current.getTracks().forEach((e=>e.stop())),l.current=null,n(!1))}),[]),p=h.useCallback((async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API is not supported on this device");const e=await navigator.mediaDevices.enumerateDevices();if(!e.some((e=>"videoinput"===e.kind)))throw new Error("No camera found on this device");const t=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:i.width},height:{ideal:i.height}}});c.current=t,s(!0)}catch(e){throw console.error("Failed to start background camera:",e),tr.create({title:`Failed to start background camera: ${e}`,type:"error",duration:2e3}),e}}),[i]),m=h.useCallback((()=>{c.current&&(c.current.getTracks().forEach((e=>e.stop())),c.current=null,s(!1))}),[]),f=h.useMemo((()=>({isStreaming:r,stream:l.current,startCamera:u,stopCamera:g,cameraConfig:i,setCameraConfig:a,videoRef:d,backgroundStream:c.current,startBackgroundCamera:p,stopBackgroundCamera:m,isBackgroundStreaming:o})),[r,u,g,i,o,p,m]);return t.jsx(or.Provider,{value:f,children:e})}function ir(){const e=h.useContext(or);if(!e)throw new Error("useCamera must be used within a CameraProvider");return e}function ar(e,t,r){const[n,o]=h.useState((()=>{try{const r=window.localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.error(`Error reading localStorage key "${e}":`,r),t}}));return[n,t=>{try{const s=t instanceof Function?t(n):t,i=r?.filter?r.filter(s):s;o(s),window.localStorage.setItem(e,JSON.stringify(i))}catch(s){console.error(`Error setting localStorage key "${e}":`,s)}}]}class lr{static instance;errorHistory=[];maxHistorySize=100;recoveryStrategies=new Map;static getInstance(){return lr.instance||(lr.instance=new lr),lr.instance}constructor(){this.setupGlobalHandlers(),this.setupDefaultRecoveryStrategies()}setupGlobalHandlers(){window.addEventListener("unhandledrejection",(e=>{console.error("🚨 未处理的Promise rejection:",e.reason);const t={type:"unknown",message:e.reason?.message||"异步操作失败",originalError:e.reason,context:"unhandledrejection",timestamp:Date.now(),recoverable:!1};this.handleError(t),e.preventDefault()})),window.addEventListener("error",(e=>{console.error("🚨 全局JavaScript错误:",e.error);const t={type:"unknown",message:e.message,originalError:e.error,context:`${e.filename}:${e.lineno}:${e.colno}`,timestamp:Date.now(),recoverable:!1};this.handleError(t)}))}setupDefaultRecoveryStrategies(){this.recoveryStrategies.set("websocket",{attempt:async()=>{console.log("🔄 尝试WebSocket重连...")},maxRetries:3,retryDelay:2e3}),this.recoveryStrategies.set("network",{attempt:async()=>{console.log("🔄 检查网络连接...")},maxRetries:2,retryDelay:1e3})}handleError(e){this.addToHistory(e),console.error(`🚨 [${e.type.toUpperCase()}] ${e.message}`,{context:e.context,originalError:e.originalError,timestamp:new Date(e.timestamp).toISOString()}),this.notifyUser(e),e.recoverable&&this.attemptRecovery(e.type),this.reportToMonitoring(e)}handleNetworkError(e,t){const r={type:"network",message:this.getNetworkErrorMessage(e),originalError:e,context:t,timestamp:Date.now(),recoverable:!0};this.handleError(r)}handleWebSocketError(e,t){const r={type:"websocket",message:"连接已断开，正在尝试重连...",originalError:e,context:t,timestamp:Date.now(),recoverable:!0};this.handleError(r)}handleMediaError(e,t){const r={type:"media",message:"媒体播放失败，请检查文件格式",originalError:e,context:t,timestamp:Date.now(),recoverable:!1};this.handleError(r)}handlePermissionError(e,t){const r={type:"permission",message:"权限被拒绝，请检查浏览器设置",originalError:e,context:t,timestamp:Date.now(),recoverable:!1};this.handleError(r)}getNetworkErrorMessage(e){const t=e.message.toLowerCase();return t.includes("fetch")?"网络请求失败，请检查网络连接":t.includes("timeout")?"请求超时，请稍后重试":t.includes("cors")?"跨域请求被阻止":"网络连接异常，请检查网络设置"}notifyUser(e){if(this.errorHistory.filter((t=>t.type===e.type&&t.message===e.message)).find((e=>Date.now()-e.timestamp<6e4)))return;const t=e.recoverable?"warning":"error",r=e.recoverable?3e3:5e3;tr.create({title:this.getErrorTitle(e.type),description:e.message,type:t,duration:r})}getErrorTitle(e){return{network:"网络错误",websocket:"连接错误",media:"媒体错误",permission:"权限错误",validation:"数据验证错误",unknown:"系统错误"}[e]||"未知错误"}async attemptRecovery(e){const t=this.recoveryStrategies.get(e);if(!t)return;let r=0;for(;r<t.maxRetries;)try{return console.log(`🔄 尝试恢复 ${e} (${r+1}/${t.maxRetries})`),await t.attempt(),void console.log(`✅ ${e} 恢复成功`)}catch(n){r++,console.warn(`❌ 恢复失败 (${r}/${t.maxRetries}):`,n),r<t.maxRetries&&await new Promise((e=>setTimeout(e,t.retryDelay)))}console.error(`💀 ${e} 恢复失败，已达到最大重试次数`)}addToHistory(e){this.errorHistory.push(e),this.errorHistory.length>this.maxHistorySize&&this.errorHistory.shift()}reportToMonitoring(e){}getErrorHistory(){return Object.freeze([...this.errorHistory])}clearErrorHistory(){this.errorHistory=[]}registerRecoveryStrategy(e,t){this.recoveryStrategies.set(e,t)}}const cr=lr.getInstance();class dr{static instance;ws=null;messageSubject=new Nt;stateSubject=new Nt;currentState="CLOSED";static getInstance(){return dr.instance||(dr.instance=new dr),dr.instance}initializeConnection(){this.sendMessage({type:"fetch-backgrounds"}),this.sendMessage({type:"fetch-configs"}),this.sendMessage({type:"fetch-history-list"}),this.sendMessage({type:"create-new-history"})}connect(e){this.ws?.readyState!==WebSocket.CONNECTING&&this.ws?.readyState!==WebSocket.OPEN||this.disconnect();try{this.ws=new WebSocket(e),this.currentState="CONNECTING",this.stateSubject.next("CONNECTING"),this.ws.onopen=()=>{this.currentState="OPEN",this.stateSubject.next("OPEN"),this.initializeConnection()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.messageSubject.next(t)}catch(t){console.error("Failed to parse WebSocket message:",t),cr.handleWebSocketError(t,"Message parsing failed")}},this.ws.onclose=e=>{this.currentState="CLOSED",this.stateSubject.next("CLOSED"),e.wasClean||(console.warn("🔌 WebSocket连接异常关闭:",e.code,e.reason),cr.handleWebSocketError(new Error(`Connection closed unexpectedly: ${e.reason||e.code}`),"Connection lost"))},this.ws.onerror=e=>{this.currentState="CLOSED",this.stateSubject.next("CLOSED"),console.error("🚨 WebSocket连接错误:",e),cr.handleWebSocketError(new Error("WebSocket connection failed"),"Connection error")}}catch(t){console.error("Failed to connect to WebSocket:",t),this.currentState="CLOSED",this.stateSubject.next("CLOSED"),cr.handleWebSocketError(t,"Connection initialization failed")}}sendMessage(e){this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):(console.warn("WebSocket is not open. Unable to send message:",e),tr.create({title:"WebSocket is not open.",type:"error",duration:2e3}))}onMessage(e){return this.messageSubject.subscribe(e)}onStateChange(e){return this.stateSubject.subscribe(e)}disconnect(){this.ws?.close(),this.ws=null}getCurrentState(){return this.currentState}}const ur=dr.getInstance(),hr={network:{defaultHost:"127.0.0.1",defaultPort:12393,fallbackPorts:[12393,8080,3e3,5e3],wsScheme:"ws",httpScheme:"http"},timeouts:{autoCloseDelay:3e3,taskInterval:3e3,reconnectDelay:1e3,vadMisfireTimeout:2e3,healthCheckTimeout:5e3},development:{devServerPort:3e3,hmrPort:5173,detectDevPorts:[5173,3e3,8080]},paths:{libsPath:"/libs/",cachePath:"/cache/",staticPath:"/static/"},ui:{toastDuration:2e3,transitionDuration:300,debounceDelay:500}};class gr{static instance;config;constructor(){this.config={...hr},this.loadFromEnv()}static getInstance(){return gr.instance||(gr.instance=new gr),gr.instance}loadFromEnv(){}get network(){return this.config.network}get timeouts(){return this.config.timeouts}get development(){return this.config.development}get paths(){return this.config.paths}get ui(){return this.config.ui}getWsUrl(e,t){const r=e||this.config.network.defaultHost,n=t||this.config.network.defaultPort;return`${this.config.network.wsScheme}://${r}:${n}/client-ws`}getHttpUrl(e,t){const r=e||this.config.network.defaultHost,n=t||this.config.network.defaultPort;return`${this.config.network.httpScheme}://${r}:${n}`}isDevPort(e){return this.config.development.detectDevPorts.includes(e)}getMediaUrl(e,t){return`/${e}/${t}`}updateConfig(e){this.config={...this.config,...e}}getConfig(){return Object.freeze({...this.config})}}const pr=gr.getInstance();pr.network,pr.timeouts,pr.development,pr.paths,pr.ui;const mr={BASE_URL:"./",DEV:!1,MODE:"web",PROD:!0,SSR:!1};function fr(){const e=mr?.VITE_SERVER_HOST,t=mr?.VITE_SERVER_PORT,r=mr?.VITE_API_BASE_URL;if(r){const e=new URL(r),t=`${e.protocol}//${e.host}`,n=`${"https:"===e.protocol?"wss:":"ws:"}//${e.host}/client-ws`;return console.log(`🌐 使用环境变量API地址: ${t}`),{host:e.hostname,port:parseInt(e.port)||("https:"===e.protocol?443:80),baseUrl:t,wsUrl:n}}if(e||t){const r=e||pr.network.defaultHost,n=t?parseInt(t):pr.network.defaultPort,o=pr.getHttpUrl(r,n),s=pr.getWsUrl(r,n);return console.log(`🌐 使用环境变量配置: ${o}`),{host:r,port:n,baseUrl:o,wsUrl:s}}const n=function(){if("undefined"!=typeof window)try{const e=new URL(window.location.href);return`${e.protocol}//${e.host}`}catch(e){console.warn("无法解析当前URL，使用默认配置:",e)}return pr.getHttpUrl()}(),o=new URL(n);let s,i=o.hostname;const a=o.port?parseInt(o.port):"https:"===o.protocol?443:80;pr.isDevPort(a)?(s=pr.network.defaultPort,console.log(`🔧 检测到开发环境 (端口:${a})，API地址: ${i}:${s}`)):a===pr.network.defaultPort?(s=pr.network.defaultPort,console.log(`🚀 检测到标准部署环境，API地址: ${i}:${s}`)):(s=pr.network.defaultPort,console.log(`🌐 未知部署环境 (端口:${a})，尝试API地址: ${i}:${s}`));const l=pr.getHttpUrl(i,s),c=pr.getWsUrl(i,s);return console.log(`🌐 最终服务器配置: ${l} (当前页面: ${n})`),{host:i,port:s,wsUrl:c,baseUrl:l}}function xr(e,t){return pr.getMediaUrl(e,t)}const br=function(){const e=fr();return console.log(`🌐 自动检测服务器地址: ${e.baseUrl}`),{baseUrl:e.baseUrl,wsUrl:e.wsUrl}}(),wr=br.wsUrl,vr=br.baseUrl,yr=g.createContext({sendMessage:ur.sendMessage.bind(ur),wsState:"CLOSED",reconnect:()=>ur.connect(wr),wsUrl:wr,setWsUrl:()=>{},baseUrl:vr,setBaseUrl:()=>{}}),jr=()=>{const e=h.useContext(yr);if(!e)throw new Error("useWebSocket must be used within a WebSocketProvider");return e},Cr=wr,Sr=vr,kr=h.createContext(null);function Er({children:e}){const{baseUrl:r}=jr(),n=`${r}/bg/ceiling-window-room-night.jpeg`,[o,s]=ar("backgroundUrl",n),[i,a]=h.useState([]),l=h.useCallback((()=>{s(n)}),[s,n]),c=h.useCallback((e=>{a((t=>[...t,e]))}),[]),d=h.useCallback((e=>{a((t=>t.filter((t=>t.name!==e))))}),[]),u=h.useMemo((()=>o===n),[o,n]),[g,p]=h.useState(!1),m=h.useMemo((()=>({backgroundUrl:o,setBackgroundUrl:s,backgroundFiles:i,setBackgroundFiles:a,resetBackground:l,addBackgroundFile:c,removeBackgroundFile:d,isDefaultBackground:u,useCameraBackground:g,setUseCameraBackground:p})),[o,s,i,l,c,d,u,g]);return t.jsx(kr.Provider,{value:m,children:e})}const Ar=()=>{const e=h.useContext(kr);if(!e)throw new Error("useBgUrl must be used within a BgUrlProvider");return e},Mr=h.memo((({children:e})=>{const r=h.useRef(null),{backgroundStream:n,isBackgroundStreaming:o,startBackgroundCamera:s,stopBackgroundCamera:i}=ir(),{useCameraBackground:a,backgroundUrl:l}=Ar(),[c,d]=h.useState(!0);return h.useEffect((()=>{a?s():i()}),[a,s,i]),h.useEffect((()=>{r.current&&n&&(r.current.srcObject=n)}),[n]),t.jsxs(p,{...Qt.container,children:[a?t.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,style:{...Qt.video,display:o?"block":"none",transform:"scaleX(-1)"}}):c&&l?t.jsx(m,{...Qt.image,src:l,alt:"",onError:()=>d(!1)}):null,e]})}));Mr.displayName="Background";const Ir="Hi, I'm some random AI VTuber. Who the hell are ya? Ahh, you must be amazed by my awesomeness, right? right?",Rr=h.createContext(null),Tr=h.memo((({children:e})=>{const[r,n]=h.useState(Ir),[o,s]=h.useState(!0),i=h.useMemo((()=>({subtitleText:r,setSubtitleText:n,showSubtitle:o,setShowSubtitle:s})),[r,o]);return t.jsx(Rr.Provider,{value:i,children:e})}));function Pr(){const e=h.useContext(Rr);if(!e)throw new Error("useSubtitle must be used within a SubtitleProvider");return e}const Dr=h.memo((({text:e})=>t.jsx(f,{...er.text,children:e})));Dr.displayName="SubtitleText";const Lr=h.memo((()=>{const{subtitleText:e,isLoaded:r}=(()=>{const e=Pr();return{subtitleText:h.useMemo((()=>e&&e.subtitleText?e.subtitleText.replace(/\[[\w\s]*\]/g,"").trim():null),[e?.subtitleText]),isLoaded:!!e}})(),{showSubtitle:n}=Pr();return r&&e&&n?t.jsx(p,{...er.container,children:t.jsx(Dr,{text:e})}):null}));Lr.displayName="Subtitle";const zr="",Ur="",_r=[],$r=h.createContext(null);function Or({children:e}){const[r,n]=h.useState(zr),[o,s]=h.useState(Ur),[i,a]=h.useState(_r),l=h.useCallback((e=>i.find((t=>t.name===e))?.filename),[i]),c=h.useMemo((()=>({confName:r,confUid:o,configFiles:i,setConfName:n,setConfUid:s,setConfigFiles:a,getFilenameByName:l})),[r,o,i,l]);return h.useEffect((()=>{window.api?.updateConfigFiles?.(i)}),[i]),t.jsx($r.Provider,{value:c,children:e})}const Fr=()=>{const e=h.useContext($r);if(!e)throw new Error("useConfig must be used within a CharacterConfigProvider");return e},Br={scrollToResize:!0},Nr=!1,Wr=h.createContext(null);function Hr({children:e}){const{confUid:r}=Fr(),[n,o]=h.useState(!1),[s,i]=h.useState(Nr);h.useEffect((()=>{const e=window.api?.onModeChanged((e=>{o("pet"===e)}));return()=>e?.()}),[]);const a=(e,t)=>`${e}_${t?"pet":"window"}`,[l,c]=ar("modelInfo",Br,{filter:e=>e?{...e,url:""}:e}),[d,u]=ar("scale_memory",{}),g=e=>{if(e?.url){if(!r)return console.warn("Attempting to set model info without confUid"),void tr.create({title:"Attempting to set model info without confUid",type:"error",duration:2e3});if(JSON.stringify(e)!==JSON.stringify(l))if(e){const t=a(r,n);let o;const s=d[t];void 0!==s?o=s:(o=Number(e.kScale||.001),u((e=>({...e,[t]:o})))),console.log("finalScale",o),c({...e,kScale:o,pointerInteractive:"pointerInteractive"in e?e.pointerInteractive:l?.pointerInteractive??!1,scrollToResize:"scrollToResize"in e?e.scrollToResize:l?.scrollToResize??!0})}else c(void 0)}},p=h.useCallback((e=>{if(l){const t=a(r,n),o=Number(e.toFixed(8));u((e=>({...e,[t]:o}))),c({...l,kScale:o})}}),[l,r,n,u,c]);h.useEffect((()=>{if(l){const e=a(r,n),t=d[e];void 0!==t&&t!==Number(l.kScale)&&g({...l,kScale:t})}}),[n,l]);const m=h.useMemo((()=>({modelInfo:l,setModelInfo:g,isLoading:s,setIsLoading:i,updateModelScale:p})),[l,s,p]);return t.jsx(Wr.Provider,{value:m,children:e})}function Vr(){const e=h.useContext(Wr);if(!e)throw new Error("useLive2DConfig must be used within a Live2DConfigProvider");return e}const Gr={},qr=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){const e=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),s=o?.nonce||o?.getAttribute("nonce");n=Promise.allSettled(t.map((t=>{if(t=function(e,t){return new URL(e,t).href}(t,r),t in Gr)return;Gr[t]=!0;const n=t.endsWith(".css"),o=n?'[rel="stylesheet"]':"";if(!!r)for(let r=e.length-1;r>=0;r--){const o=e[r];if(o.href===t&&(!n||"stylesheet"===o.rel))return}else if(document.querySelector(`link[href="${t}"]${o}`))return;const i=document.createElement("link");return i.rel=n?"stylesheet":"modulepreload",n||(i.as="script"),i.crossOrigin="",i.href=t,s&&i.setAttribute("nonce",s),document.head.appendChild(i),n?new Promise(((e,r)=>{i.addEventListener("load",e),i.addEventListener("error",(()=>r(new Error(`Unable to preload CSS for ${t}`))))})):void 0})))}function o(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then((t=>{for(const e of t||[])"rejected"===e.status&&o(e.reason);return e().catch(o)}))};const Kr=new class{queue=[];running=!1;taskInterval;pendingComplete=!1;activeTasks=new Set;constructor(e=3e3){this.taskInterval=e}addTask(e){this.queue.push(e),this.runNextTask()}clearQueue(){this.queue=[],this.activeTasks.clear(),this.running=!1}async runNextTask(){if(this.running||0===this.queue.length)return void(0===this.queue.length&&0===this.activeTasks.size&&this.pendingComplete&&(this.pendingComplete=!1,await new Promise((e=>setTimeout(e,this.taskInterval)))));this.running=!0;const e=this.queue.shift();if(e){const r=e();this.activeTasks.add(r);try{await r,await new Promise((e=>setTimeout(e,this.taskInterval)))}catch(t){console.error("Task Queue Error",t)}finally{this.activeTasks.delete(r),this.running=!1,this.runNextTask()}}}hasTask(){return this.queue.length>0||this.activeTasks.size>0||this.running}waitForCompletion(){return this.pendingComplete=!0,new Promise((e=>{const t=()=>{this.hasTask()?setTimeout(t,100):e()};t()}))}}(20),Xr=h.createContext(void 0);function Jr({children:e}){const[r,n]=h.useState(null),[o,s]=h.useState(!1),[i,a]=h.useState("");return t.jsx(Xr.Provider,{value:{stream:r,isStreaming:o,error:i,startCapture:async()=>{try{let e;if(window.electron){const t={video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:await window.electron.ipcRenderer.invoke("get-screen-capture"),minWidth:1280,maxWidth:1280,minHeight:720,maxHeight:720}},audio:!1};e=await navigator.mediaDevices.getUserMedia(t)}else{const t={video:!0,audio:!1};e=await navigator.mediaDevices.getDisplayMedia(t)}n(e),s(!0),a("")}catch(e){a("Failed to start screen capture"),tr.create({title:`Failed to start screen capture: ${e}`,type:"error",duration:2e3}),console.error(e)}},stopCapture:()=>{r&&(r.getTracks().forEach((e=>e.stop())),n(null),s(!1))}},children:e})}function Yr(){const{stream:e}=ir(),{stream:t}=(()=>{const e=h.useContext(Xr);if(void 0===e)throw new Error("useScreenCaptureContext must be used within a ScreenCaptureProvider");return e})(),r=h.useCallback((async(e,t)=>{if(!e)return console.warn(`No ${t} stream available`),null;const r=e.getVideoTracks()[0];if(!r)return console.warn(`No video track in ${t} stream`),null;const n=new ImageCapture(r);try{const e=await n.grabFrame(),t=document.createElement("canvas");t.width=e.width,t.height=e.height;const r=t.getContext("2d");return r?(r.drawImage(e,0,0),t.toDataURL("image/jpeg",.8)):(console.error("Failed to get canvas context"),null)}catch(o){return console.error(`Error capturing ${t} frame:`,o),tr.create({title:`Failed to capture ${t} frame: ${o}`,type:"error",duration:2e3}),null}}),[]);return{captureAllMedia:h.useCallback((async()=>{const n=[];if(e){const t=await r(e,"camera");t&&n.push({source:"camera",data:t,mime_type:"image/jpeg"})}if(t){const e=await r(t,"screen");e&&n.push({source:"screen",data:e,mime_type:"image/jpeg"})}return console.log("images: ",n),n}),[e,t,r])}}var Qr=(e=>(e.IDLE="idle",e.THINKING_SPEAKING="thinking-speaking",e.INTERRUPTED="interrupted",e.LOADING="loading",e.LISTENING="listening",e.WAITING="waiting",e))(Qr||{});const Zr=h.createContext(null);function en({children:e}){const[r,n]=h.useState("loading"),[o,s]=h.useState(!1),i=h.useRef(null),a=h.useCallback((e=>{const t="function"==typeof e?e(r):e;"waiting"===t?"thinking-speaking"!==r&&(n(t),i.current&&clearTimeout(i.current),i.current=setTimeout((()=>{n("idle"),i.current=null}),2e3)):(n(t),i.current&&(clearTimeout(i.current),i.current=null))}),[r]),l=h.useMemo((()=>({isIdle:"idle"===r,isThinkingSpeaking:"thinking-speaking"===r,isInterrupted:"interrupted"===r,isLoading:"loading"===r,isListening:"listening"===r,isWaiting:"waiting"===r})),[r]),c=h.useCallback((()=>{a("idle")}),[a]);h.useEffect((()=>()=>{i.current&&clearTimeout(i.current)}),[]);const d=h.useMemo((()=>({aiState:r,setAiState:a,backendSynthComplete:o,setBackendSynthComplete:s,...l,resetState:c})),[r,a,o,l,c]);return t.jsx(Zr.Provider,{value:d,children:e})}const tn=()=>{const e=h.useContext(Zr);if(!e)throw new Error("useAiState must be used within a AiStateProvider");return e},rn={positiveSpeechThreshold:50,negativeSpeechThreshold:35,redemptionFrames:35},nn=!1,on=!1,sn=!1,an=!1,ln=h.createContext(null);function cn({children:e}){const r=h.useRef(null),n=h.useRef(0),[o,s]=ar("micOn",nn),i=h.useRef(!0),[a,l]=ar("autoStopMic",on),[c,d]=ar("vadSettings",rn),[u,g]=ar("autoStartMicOn",sn),p=h.useRef(!1),[m,f]=ar("autoStartMicOnConvEnd",an),x=h.useRef(!1),[,b]=h.useReducer((e=>e+1),0),{interrupt:w}=Rn(),{sendAudioPartition:v}=(()=>{const{sendMessage:e}=jr(),{captureAllMedia:t}=Yr();return{sendAudioPartition:h.useCallback((async r=>{for(let t=0;t<r.length;t+=4096){const n=Math.min(t+4096,r.length),o=r.slice(t,n);e({type:"mic-audio-data",audio:Array.from(o)})}const n=await t();e({type:"mic-audio-end",images:n})}),[e,t])}})(),{setSubtitleText:y}=h.useContext(Rr),{aiState:j,setAiState:C}=h.useContext(Zr),S=h.useRef(w),k=h.useRef(v),E=h.useRef(j),A=h.useRef(y),M=h.useRef(C),I=h.useRef(!1);h.useEffect((()=>{E.current=j}),[j]),h.useEffect((()=>{S.current=w}),[w]),h.useEffect((()=>{k.current=v}),[v]),h.useEffect((()=>{A.current=y}),[y]),h.useEffect((()=>{M.current=C}),[C]),h.useEffect((()=>{i.current=a}),[]),h.useEffect((()=>{p.current=u}),[]),h.useEffect((()=>{x.current=m}),[]);const R=h.useCallback((e=>{n.current=e,b()}),[]),T=h.useCallback((()=>{console.log("Speech started"),"thinking-speaking"===E.current&&S.current(),I.current=!0,M.current("listening")}),[]),P=h.useCallback((e=>{e.isSpeech>n.current&&R(e.isSpeech)}),[]),D=h.useCallback((e=>{I.current&&(console.log("Speech ended"),Kr.clearQueue(),i.current?_():console.log("Auto stop mic is on, keeping mic active"),R(0),k.current(e),I.current=!1)}),[]),L=h.useCallback((()=>{I.current&&(console.log("VAD misfire detected"),R(0),I.current=!1,"interrupted"!==E.current&&"listening"!==E.current||M.current("idle"),A.current("聞こえないよ〜"))}),[]),z=h.useCallback((e=>{d(e),r.current&&(_(),setTimeout((()=>{U()}),100))}),[]),U=h.useCallback((async()=>{try{r.current?(console.log("Starting VAD"),r.current.start()):(console.log("Initializing VAD"),await(async()=>{try{const e=await qr((()=>import("./vendor-DxCmb_fS.js").then((e=>e.o))),__vite__mapDeps([0,1,2]),import.meta.url);e.env.wasm.wasmPaths="/libs/",e.env.wasm.numThreads=1,e.env.wasm.simd=!0}catch(n){console.warn("onnxruntime-web not available, proceeding anyway:",n)}const e=await qr((()=>import("./vendor-DxCmb_fS.js").then((e=>e.i))),__vite__mapDeps([0,1,2]),import.meta.url),t=await e.MicVAD.new({model:"v5",preSpeechPadFrames:20,positiveSpeechThreshold:c.positiveSpeechThreshold/100,negativeSpeechThreshold:c.negativeSpeechThreshold/100,redemptionFrames:c.redemptionFrames,baseAssetPath:"/libs/",onnxWASMBasePath:"/libs/",onSpeechStart:T,onFrameProcessed:P,onSpeechEnd:D,onVADMisfire:L});r.current=t,t.start()})()),s(!0)}catch(e){console.error("Failed to start VAD:",e),tr.create({title:`Failed to start VAD: ${e}`,type:"error",duration:2e3})}}),[]),_=h.useCallback((()=>{console.log("Stopping VAD"),r.current?(r.current.pause(),r.current.destroy(),r.current=null,console.log("VAD stopped and destroyed successfully"),R(0)):console.log("VAD instance not found"),s(!1),I.current=!1}),[]),$=h.useCallback((e=>{i.current=e,l(e),b()}),[]),O=h.useCallback((e=>{p.current=e,g(e),b()}),[]),F=h.useCallback((e=>{x.current=e,f(e),b()}),[]),B=h.useMemo((()=>({autoStopMic:i.current,micOn:o,setMicOn:s,setAutoStopMic:$,startMic:U,stopMic:_,previousTriggeredProbability:n.current,setPreviousTriggeredProbability:R,settings:c,updateSettings:z,autoStartMicOn:p.current,setAutoStartMicOn:O,autoStartMicOnConvEnd:x.current,setAutoStartMicOnConvEnd:F})),[o,U,_,c,z]);return t.jsx(ln.Provider,{value:B,children:e})}const dn=()=>{const e=h.useContext(ln);if(!e)throw new Error("useVAD must be used within a VADProvider");return e};function un(){const{startMic:e,stopMic:t,micOn:r}=dn(),{aiState:n,setAiState:o}=tn();return{handleMicToggle:async()=>{r?(t(),"listening"===n&&o("idle")):await e()},micOn:r}}function hn(){const{sendMessage:e}=jr(),{confName:t,getFilenameByName:r}=Fr(),{interrupt:n}=Rn(),{stopMic:o}=dn(),{setSubtitleText:s}=Pr(),{setAiState:i}=tn(),{setModelInfo:a}=Vr();return{switchCharacter:h.useCallback((l=>{r(t)!==l?(s("新しいキャラクターを読み込み中..."),n(),o(),i("loading"),a(void 0),e({type:"switch-config",file:l}),console.log("Switch Character fileName: ",l)):console.log("Skipping character switch - same configuration file")}),[t,r,e,n,o,s,i])}}const gn=x((e=>({forceIgnoreMouse:!1,setForceIgnoreMouse:t=>e({forceIgnoreMouse:t})})));function pn(){const{forceIgnoreMouse:e,setForceIgnoreMouse:t}=gn();return{forceIgnoreMouse:e,setForceIgnoreMouse:t}}const mn=null,fn=h.createContext(null),xn=h.memo((({children:e})=>{const[r,n]=h.useState(mn),o=h.useCallback((e=>{n((t=>t?Object.assign(t,e):null))}),[]),s=h.useMemo((()=>({currentModel:r,setCurrentModel:n,updateModelState:o})),[r,o]);return t.jsx(fn.Provider,{value:s,children:e})}));function bn(){const e=h.useContext(fn);if(!e)throw new Error("useLive2DModel must be used within a Live2DModelProvider");return e}const wn=(e,t,r,n,o)=>{if(!e)return;const s=Number(n||0),i=Number(o||0),a=(t-e.width)/2+s,l=(r-e.height)/2+i;e.position.set(a,l)},vn=({isPet:e,modelInfo:t})=>{const r=h.useRef(null),n=h.useRef(null),o=h.useRef(null),s=h.useRef(null),i=h.useRef(void 0),{setCurrentModel:a}=bn(),{setIsLoading:l}=Vr(),c=h.useRef(!1),{setAiState:d,aiState:u}=tn(),[g,p]=h.useState(!1),{forceIgnoreMouse:m}=pn(),f=h.useCallback((()=>{o.current&&(o.current.removeAllListeners(),a(null),n.current&&(n.current.stage.removeChild(o.current),o.current.destroy({children:!0,texture:!0,baseTexture:!0}),Wt(),o.current=null)),p(!1)}),[a]),x=h.useCallback((()=>{n.current&&(o.current&&f(),n.current.stage.removeChildren(),Wt(),n.current.renderer.clear(),n.current.destroy(!0,{children:!0,texture:!0,baseTexture:!0}),Ht(),n.current=null)}),[f]);h.useEffect((()=>{if(!n.current&&r.current){const e=new Vt({view:r.current,autoStart:!0,width:window.innerWidth,height:window.innerHeight,backgroundAlpha:0,antialias:!0,clearBeforeRender:!0,preserveDrawingBuffer:!1,powerPreference:"high-performance",resolution:window.devicePixelRatio||1,autoDensity:!0});e.ticker.add((()=>{e.renderer&&e.renderer.render(e.stage)})),n.current=e}return()=>{x()}}),[x]);const b=h.useCallback((async e=>{n.current&&t&&(o.current&&(o.current.removeAllListeners(),n.current.stage.removeChild(o.current),o.current.destroy({children:!0,texture:!0,baseTexture:!0}),Wt()),o.current=e,a(e),n.current.stage.addChild(e),e.interactive=!0,e.cursor="pointer",p(!0))}),[a]),w=h.useCallback((()=>{if(!o.current)return;((e,t)=>{if(!e||!t)return;const r=Number(window.devicePixelRatio||1);e.scale.set(Number(t)),e.filters&&e.filters.forEach((e=>{"resolution"in e&&Object.defineProperty(e,"resolution",{value:r})}))})(o.current,i.current);const{width:r,height:n}=e?{width:window.innerWidth,height:window.innerHeight}:s.current?.getBoundingClientRect()||{width:0,height:0};wn(o.current,r,n,t?.initialXshift,t?.initialYshift)}),[t?.initialXshift,t?.initialYshift]),v=h.useCallback((async()=>{if(t?.url&&n.current&&!c.current){console.log("Loading model:",t.url);try{c.current=!0,l(!0),d(Qr.LOADING);const e=await Gt.from(t.url,{autoHitTest:!0,autoFocus:t.pointerInteractive??!1,autoUpdate:!0,ticker:qt.shared,motionPreload:Kt.IDLE,idleMotionGroup:t.idleMotionGroupName});await b(e)}catch(e){console.error("Failed to load Live2D model:",e),tr.create({title:`Failed to load Live2D model: ${e}`,type:"error",duration:2e3})}finally{c.current=!1,l(!1),d(Qr.IDLE)}}}),[t?.url,t?.pointerInteractive,l,b]),y=h.useCallback((t=>{if(!t)return;if(t.removeAllListeners("pointerenter"),t.removeAllListeners("pointerleave"),t.removeAllListeners("rightdown"),t.removeAllListeners("pointerdown"),t.removeAllListeners("pointermove"),t.removeAllListeners("pointerup"),t.removeAllListeners("pointerupoutside"),m&&e)return t.interactive=!1,void(t.cursor="default");t.interactive=!0,t.cursor="pointer";let r=!1,n=0,o=0,s=!1;e&&(t.on("pointerenter",(()=>{window.api?.updateComponentHover("live2d-model",!0)})),t.on("pointerleave",(()=>{r||window.api?.updateComponentHover("live2d-model",!1)})),t.on("rightdown",(e=>{e.data.originalEvent.preventDefault(),window.api.showContextMenu()}))),t.on("pointerdown",(e=>{0===e.button&&(r=!0,s=!0,n=e.global.x-t.x,o=e.global.y-t.y)})),t.on("pointermove",(e=>{if(r){const r=e.global.x-n,i=e.global.y-o,a=r-t.x,l=i-t.y;Math.hypot(a,l)>5&&(s=!1),t.position.x=r,t.position.y=i}})),t.on("pointerup",(e=>{r&&(r=!1,s&&j(t,e.global.x,e.global.y))})),t.on("pointerupoutside",(()=>{r=!1}))}),[e,m]),j=h.useCallback(((e,r,n)=>{if(!t?.tapMotions)return;console.log("handleTapMotion",t?.tapMotions);const o=e.toLocal(new Xt(r,n));if(!e.hitTest(o.x,o.y).find((r=>{const n=t?.tapMotions?.[r];return!!n&&(console.log(`Found motion group for area ${r}:`,n),yn(e,n),!0)}))&&Object.keys(t.tapMotions).length>0){const r=jn(t.tapMotions);yn(e,r)}}),[t?.tapMotions]);return h.useEffect((()=>{u===Qr.IDLE&&(console.log("defaultEmotion: ",t?.defaultEmotion),t?.defaultEmotion?o.current?.internalModel.motionManager.expressionManager?.setExpression(t.defaultEmotion):o.current?.internalModel.motionManager.expressionManager?.resetExpression())}),[o.current,u,t?.defaultEmotion]),h.useEffect((()=>(t?.url&&v(),()=>{f()})),[t?.url,t?.pointerInteractive,v,f]),h.useEffect((()=>{i.current=t?.kScale}),[t?.kScale]),h.useEffect((()=>{w()}),[g,w]),h.useEffect((()=>{o.current&&g&&y(o.current)}),[g,y,m]),{canvasRef:r,appRef:n,modelRef:o,containerRef:s}},yn=(e,t)=>{if(!t||0===Object.keys(t).length)return;const r=Object.values(t).reduce(((e,t)=>e+t),0);let n=Math.random()*r;Object.entries(t).find((([t,o])=>{if(n-=o,n<=0){const n=Kr.hasTask()?Jt.NORMAL:Jt.FORCE;return console.log(`Playing weighted motion: ${t} (weight: ${o}/${r}, priority: ${n})`),e.motion(t,void 0,n),!0}return!1}))},jn=e=>{const t={};return Object.values(e).flatMap((e=>Object.entries(e))).reduce(((e,[t,r])=>(e[t]||(e[t]={total:0,count:0}),e[t].total+=r,e[t].count+=1,e)),t),Object.entries(t).reduce(((e,[t,{total:r,count:n}])=>({...e,[t]:r/n})),{})},Cn=[],Sn=[],kn=null,En="",An=h.createContext(null);function Mn({children:e}){const[r,n]=h.useState(Cn),[o,s]=h.useState(Sn),[i,a]=h.useState(kn),[l,c]=h.useState(En),[d,u]=h.useState(!1),g=h.useCallback((e=>{const t={id:Date.now().toString(),content:e,role:"human",timestamp:(new Date).toISOString()};n((e=>[...e,t]))}),[]),p=h.useCallback(((e,t,r)=>{n((n=>{const o=n[n.length-1];return d||!o||"ai"!==o.role?(u(!1),[...n,{id:Date.now().toString(),content:e,role:"ai",timestamp:(new Date).toISOString(),name:t,avatar:r}]):[...n.slice(0,-1),{...o,content:o.content+e,timestamp:(new Date).toISOString()}]}))}),[d,u]),m=h.useCallback(((e,t)=>{e||console.error("updateHistoryList: uid is null"),i||console.error("updateHistoryList: currentHistoryUid is null"),s((r=>r.map((r=>r.uid===e?{...r,latest_message:t?{content:t.content,role:t.role,timestamp:t.timestamp}:null,timestamp:t?.timestamp||r.timestamp}:r))))}),[i]),f=h.useCallback((e=>{c((t=>t+(e||"")))}),[]),x=h.useCallback((()=>{c(En)}),[]),b=h.useMemo((()=>({messages:r,historyList:o,currentHistoryUid:i,appendHumanMessage:g,appendAIMessage:p,setMessages:n,setHistoryList:s,setCurrentHistoryUid:a,updateHistoryList:m,fullResponse:l,setFullResponse:c,appendResponse:f,clearResponse:x,setForceNewMessage:u})),[r,o,i,g,p,m,l,f,x,u]);return t.jsx(An.Provider,{value:b,children:e})}function In(){const e=h.useContext(An);if(!e)throw new Error("useChatHistory must be used within a ChatHistoryProvider");return e}const Rn=()=>{const{aiState:e,setAiState:t}=tn(),{sendMessage:r}=jr(),{fullResponse:n,clearResponse:o}=In(),{currentModel:s}=bn(),{subtitleText:i,setSubtitleText:a}=Pr();return{interrupt:(l=!0)=>{"thinking-speaking"===e&&(console.log("Interrupting conversation chain"),l&&r({type:"interrupt-signal",text:n}),t("interrupted"),Kr.clearQueue(),s?s.stopSpeaking():console.error("Live2D model is not initialized"),o(),"考え中..."===i&&a(""),console.log("Interrupted!"))}}},Tn=()=>{const{modelInfo:e}=Vr(),{aiState:t,backendSynthComplete:r,setBackendSynthComplete:n}=tn(),{setSubtitleText:o}=Pr(),{appendResponse:s,appendAIMessage:i}=In(),{currentModel:a}=bn(),{sendMessage:l}=jr(),c=h.useRef({aiState:t,currentModel:a,setSubtitleText:o,appendResponse:s,appendAIMessage:i,modelInfo:e});c.current={aiState:t,currentModel:a,setSubtitleText:o,appendResponse:s,appendAIMessage:i,modelInfo:e};h.useEffect((()=>{let e=!0;return(async()=>{await Kr.waitForCompletion(),e&&r&&(l({type:"frontend-playback-complete"}),n(!1))})(),()=>{e=!1}}),[r,l,n]);return{addAudioTask:async e=>{const{aiState:t}=c.current;"interrupted"!==t?(console.log(`Adding audio task ${e.displayText?.text} to queue`),Kr.addTask((()=>(e=>new Promise((t=>{const{aiState:r,currentModel:n,setSubtitleText:o,appendResponse:s,appendAIMessage:i,modelInfo:a}=c.current;if("interrupted"===r)return console.error("Audio playback blocked. State:",r),void t();const{audioBase64:d,displayText:u,expressions:h,forwarded:g}=e;if(u&&(s(u.text),i(u.text,u.name,u.avatar),d&&o(u.text),g||l({type:"audio-play-start",display_text:u,forwarded:!0})),!n)return console.error("Model not initialized"),void t();try{if(void 0!==h?.[0]){const e=h[0];let t=e;"string"==typeof e&&a?.emotionMap&&(t=a.emotionMap[e]),void 0!==t&&n.expression(t)}let e=!1;d?n.speak(`data:audio/wav;base64,${d}`,{onFinish:()=>{console.log("Voiceline is over"),e=!0,t()},onError:r=>{console.error("Audio playback error:",r),e=!0,t()}}):t();const r=()=>{e||setTimeout(r,100)};r()}catch(p){console.error("Speak function error:",p),tr.create({title:`Speak function error: ${p}`,type:"error",duration:2e3}),t()}})))(e)))):console.log("Skipping audio task due to interrupted state")},appendResponse:s}},Pn=h.memo((({isPet:e})=>{const{modelInfo:r,isLoading:n}=Vr(),{forceIgnoreMouse:o}=pn();!function({isPet:e}){const{handleMicToggle:t}=un(),{interrupt:r}=Rn(),{modelInfo:n,setModelInfo:o}=Vr(),{switchCharacter:s}=hn(),{setForceIgnoreMouse:i}=pn(),a=h.useCallback((()=>{t()}),[t]),l=h.useCallback((()=>{r()}),[r]),c=h.useCallback((()=>{n&&o({...n,scrollToResize:!n.scrollToResize})}),[n,o]),d=h.useCallback(((e,t)=>{s(t)}),[s]),u=h.useCallback(((e,t)=>{console.log("Force ignore mouse changed:",t),i(t)}),[i]),g=h.useCallback((()=>{window.api.toggleForceIgnoreMouse()}),[]);h.useEffect((()=>{if(window.electron?.ipcRenderer&&e)return window.electron.ipcRenderer.removeAllListeners("mic-toggle"),window.electron.ipcRenderer.removeAllListeners("interrupt"),window.electron.ipcRenderer.removeAllListeners("toggle-scroll-to-resize"),window.electron.ipcRenderer.removeAllListeners("switch-character"),window.electron.ipcRenderer.removeAllListeners("toggle-force-ignore-mouse"),window.electron.ipcRenderer.removeAllListeners("force-ignore-mouse-changed"),window.electron.ipcRenderer.on("mic-toggle",a),window.electron.ipcRenderer.on("interrupt",l),window.electron.ipcRenderer.on("toggle-scroll-to-resize",c),window.electron.ipcRenderer.on("switch-character",d),window.electron.ipcRenderer.on("toggle-force-ignore-mouse",g),window.electron.ipcRenderer.on("force-ignore-mouse-changed",u),()=>{window.electron?.ipcRenderer.removeAllListeners("mic-toggle"),window.electron?.ipcRenderer.removeAllListeners("interrupt"),window.electron?.ipcRenderer.removeAllListeners("toggle-scroll-to-resize"),window.electron?.ipcRenderer.removeAllListeners("switch-character"),window.electron?.ipcRenderer.removeAllListeners("toggle-force-ignore-mouse"),window.electron?.ipcRenderer.removeAllListeners("force-ignore-mouse-changed")}}),[a,l,c,d,g,u,e])}({isPet:e});const{canvasRef:s,appRef:i,modelRef:a,containerRef:l}=vn({isPet:e,modelInfo:r});return((e,t,r,n,o)=>{const{updateModelScale:s}=Vr(),i=h.useRef(null),a=h.useRef(null),l=h.useCallback((e=>{if(!r.current||!n?.scrollToResize)return;e.preventDefault();const t=((e,t)=>{const r=t>0?-.01:.01,n=e.scale.x,o=n+.3*(n+r-n);return e.scale.set(o),o})(r.current,e.deltaY);(!a.current||Math.abs(t-a.current)>1e-4)&&(i.current&&clearTimeout(i.current),i.current=setTimeout((()=>{s(t),a.current=t}),500))}),[r,n?.scrollToResize,s]);h.useEffect((()=>{const t=e.current?.querySelector("canvas");if(t)return t.addEventListener("wheel",l,{passive:!1}),()=>t.removeEventListener("wheel",l)}),[l,e]),h.useEffect((()=>{const s=new ResizeObserver((()=>{if(r.current&&t.current){const{width:s,height:i}=o?{width:window.innerWidth,height:window.innerHeight}:e.current?.getBoundingClientRect()||{width:0,height:0};t.current.renderer.resize(s,i),t.current.renderer.clear(),wn(r.current,s,i,n?.initialXshift,n?.initialYshift)}}));return e.current&&s.observe(e.current),()=>{s.disconnect()}}),[r,e,o,t]),h.useEffect((()=>()=>{i.current&&clearTimeout(i.current)}),[])})(l,i,a,r,e),Rn(),Tn(),h.useEffect((()=>(a.current&&(window.live2d={expression:e=>a.current?.expression(e),setExpression:e=>{void 0!==e&&a.current?.internalModel.motionManager.expressionManager?.setExpression(e)},setRandomExpression:()=>a.current?.internalModel.motionManager.expressionManager?.setRandomExpression(),getExpressions:()=>a.current?.internalModel.motionManager.expressionManager?.definitions.map((e=>e.name))}),()=>{delete window.live2d})),[a.current]),t.jsx("div",{ref:l,style:{width:e?"100vw":"100%",height:e?"100vh":"100%",pointerEvents:e&&o?"none":"auto",overflow:"hidden",opacity:n?0:1,transition:"opacity 0.3s ease-in-out"},children:t.jsx("canvas",{id:"canvas",ref:s,style:{width:"100%",height:"100%",pointerEvents:e&&o?"none":"auto",display:"block"}})})}));function Dn(){return t.jsx(Mr,{children:t.jsxs(p,{...Zt.container,children:[t.jsx(Pn,{isPet:!1}),t.jsx(Lr,{})]})})}Pn.displayName="Live2D";const Ln=void 0!==window.api,zn=("undefined"!=typeof window&&/Mobi|Android/i.test(navigator.userAgent)&&window.innerHeight,{display:"flex",alignItems:"center",justifyContent:"space-between",height:"30px",backgroundColor:"gray.800",paddingX:"10px",css:{"-webkit-app-region":"drag"}}),Un={display:"flex",alignItems:"center",justifyContent:"center",height:"30px",backgroundColor:"gray.800",css:{"-webkit-app-region":"drag","-webkit-user-select":"none"}},_n={fontSize:"sm",color:"whiteAlpha.800",textAlign:"center"},$n={display:"flex",gap:"1"},On={size:"sm",variant:"ghost",color:"whiteAlpha.800",css:{"-webkit-app-region":"no-drag"},_hover:{backgroundColor:"whiteAlpha.200"}},Fn={size:"sm",variant:"ghost",color:"whiteAlpha.800",css:{"-webkit-app-region":"no-drag"},_hover:{backgroundColor:"red.500"}};function Bn(){const[e,r]=h.useState(!1),[n,o]=h.useState(!1),s="darwin"===window.electron?.process.platform;h.useEffect((()=>(window.electron?.ipcRenderer.on("window-maximized-change",((e,t)=>{r(t)})),window.electron?.ipcRenderer.on("window-fullscreen-change",((e,t)=>{o(t)})),()=>{window.electron?.ipcRenderer.removeAllListeners("window-maximized-change"),window.electron?.ipcRenderer.removeAllListeners("window-fullscreen-change")})),[]);return s?t.jsx(p,{...Un,children:t.jsx(p,{..._n,children:"AI-PROJECT-X"})}):t.jsxs(p,{...zn,children:[t.jsx(p,{..._n,children:"AI-PROJECT-X"}),t.jsxs(p,{...$n,children:[t.jsx(b,{...On,onClick:()=>window.electron?.ipcRenderer.send("window-minimize"),"aria-label":"Minimize",children:t.jsx(w,{})}),t.jsx(b,{...On,onClick:()=>{n?window.electron?.ipcRenderer.send("window-unfullscreen"):window.electron?.ipcRenderer.send("window-maximize")},"aria-label":n?"Exit Full Screen":e?"Restore":"Maximize",children:n?t.jsx(y,{}):e?t.jsx(j,{}):t.jsx(C,{})}),t.jsx(b,{...Fn,onClick:()=>window.electron?.ipcRenderer.send("window-close"),"aria-label":"Close",children:t.jsx(v,{})})]})]})}function Nn(){const[e,t]=h.useState(""),[r,n]=h.useState(!1),o=jr(),{aiState:s,setAiState:i}=tn(),{interrupt:a}=Rn(),{appendHumanMessage:l}=In(),{stopMic:c,autoStopMic:d}=dn(),{captureAllMedia:u}=Yr(),{setSubtitleText:g}=Pr(),p=async()=>{if(!e.trim()||!o)return;"thinking-speaking"===s&&a();const r=await u();l(e.trim()),o.sendMessage({type:"text-input",text:e.trim(),images:r}),i("thinking-speaking"),g("考え中..."),d&&c(),t("")};return{inputText:e,setInputText:e=>{t(e.target.value)},handleSend:p,handleKeyPress:e=>{r||"Enter"!==e.key||e.shiftKey||(e.preventDefault(),p())},handleCompositionStart:()=>n(!0),handleCompositionEnd:()=>n(!1)}}const Wn={display:"flex",alignItems:"flex-end",justifyContent:"center",maxW:"fit-content",position:"absolute",bottom:"120px",left:"50%",transform:"translateX(-50%)",zIndex:1e3,userSelect:"none",willChange:"transform",padding:0},Hn={w:"400px",rounded:"xl",overflow:"hidden",boxShadow:"lg",bg:"blackAlpha.700",backdropFilter:"blur(8px)",css:{WebkitUserSelect:"none"}},Vn={p:"3",gap:1,alignItems:"stretch",justify:"flex-end"},Gn={color:"white",fontSize:"sm",lineHeight:"1.5",transition:"all 0.3s"},qn={bg:"blackAlpha.600",p:"3",borderTop:"1px",borderColor:"whiteAlpha.200"},Kn={fontSize:"xs",color:"whiteAlpha.800",transition:"all 0.3s"},Xn={size:"xs",variant:"ghost",color:"whiteAlpha.800",_hover:{bg:"whiteAlpha.200"}},Jn={bg:"blackAlpha.600",borderTop:"1px",borderColor:"whiteAlpha.200"},Yn={size:"sm",bg:"blackAlpha.500",color:"white",_placeholder:{color:"whiteAlpha.500"},borderColor:"whiteAlpha.300",_focus:{borderColor:"whiteAlpha.500",outline:"none"},flex:"1"},Qn={p:"1.5",bg:"blackAlpha.500",rounded:"lg",_hover:{bg:"blackAlpha.600"},transition:"colors",color:"whiteAlpha.800",size:"sm"},Zn=e=>({cursor:e?"grabbing":"grab",transition:e?"none":"transform 0.1s ease",_active:{cursor:"grabbing"}}),eo={position:"absolute",top:0,right:0,size:"2xs",minW:"6",height:"6",padding:0,variant:"ghost",color:"whiteAlpha.400",bg:"transparent",_hover:{bg:"blackAlpha.300",color:"whiteAlpha.800"},zIndex:10};function to({isPet:e=!1}){const{inputValue:r,handleInputChange:n,handleKeyPress:o,handleCompositionStart:s,handleCompositionEnd:i,handleInterrupt:l,handleMicToggle:c,handleSend:d,lastAIMessage:u,hasAIMessages:g,aiState:m,micOn:x}=function(){const{inputText:e,setInputText:t,handleKeyPress:r,handleCompositionStart:n,handleCompositionEnd:o,handleSend:s}=Nn(),{messages:i}=In(),{startMic:a,autoStartMicOn:l}=dn(),{handleMicToggle:c,micOn:d}=un(),{aiState:u,setAiState:h}=tn(),{interrupt:g}=Rn();return{inputValue:e,handleInputChange:e=>{t({target:{value:e.target.value}}),h(Qr.WAITING)},handleKeyPress:e=>{r(e)},handleCompositionStart:n,handleCompositionEnd:o,handleInterrupt:()=>{g(),l&&a()},handleMicToggle:c,lastAIMessage:i.filter((e=>"ai"===e.role)).slice(-1).map((e=>e.content.replace(/\[[\w\s]*\]/g,"").trim()))[0],hasAIMessages:i.some((e=>"ai"===e.role)),aiState:u,micOn:d,handleSend:s}}(),{elementRef:w,isDragging:v,handleMouseDown:y,handleMouseEnter:j,handleMouseLeave:C}=function({isPet:e=!1,componentId:t}){const[r,n]=h.useState(!1),o=h.useRef({x:0,y:0}),s=h.useRef({x:0,y:0}),i=h.useRef(null);return{elementRef:i,isDragging:r,handleMouseDown:e=>{n(!0),s.current={x:e.clientX-o.current.x,y:e.clientY-o.current.y};const t=e=>{if(!i.current)return;const t={x:e.clientX-s.current.x,y:e.clientY-s.current.y};o.current=t,i.current.style.transform=`translateX(-50%) translate(${o.current.x}px, ${o.current.y}px)`},r=()=>{n(!1),document.removeEventListener("mousemove",t,!0),document.removeEventListener("mouseup",r,!0)};document.addEventListener("mousemove",t,!0),document.addEventListener("mouseup",r,!0)},handleMouseEnter:()=>{e&&window.api?.updateComponentHover(t,!0)},handleMouseLeave:()=>{e&&!r&&window.api?.updateComponentHover(t,!1)}}}({isPet:e,componentId:"input-subtitle"}),[L,z]=h.useState(!0),U=h.useCallback((()=>{e&&window.api?.updateComponentHover("input-subtitle",!1),z(!1)}),[e]),_=()=>{z(!0)};return h.useEffect((()=>{if(e){const e=window.api?.onToggleInputSubtitle((()=>{L?U():_()}));return()=>e?.()}return()=>{}}),[U,e,L]),h.useEffect((()=>(window.inputSubtitle={open:_,close:U},()=>{delete window.inputSubtitle})),[e,U]),L?t.jsx(p,{ref:w,...Wn,...Zn(v),onMouseDown:y,onMouseEnter:j,onMouseLeave:C,children:t.jsxs(p,{...Hn,children:[t.jsx(b,{"aria-label":"Close subtitle",onClick:U,...eo,children:t.jsx(S,{size:12})}),g&&t.jsx(k,{minH:u?"32px":"0px",...Vn,children:u&&t.jsx(f,{...Gn,children:u})}),t.jsx(p,{...qn,children:t.jsxs(E,{align:"center",justify:"space-between",color:"whiteAlpha.700",children:[t.jsxs(E,{align:"center",gap:"2",children:[t.jsx(A,{size:16}),t.jsx(f,{...Kn,children:m})]}),t.jsxs(E,{gap:"2",children:[t.jsx(b,{"aria-label":"Toggle microphone",onClick:c,...Xn,children:x?t.jsx(M,{size:16}):t.jsx(I,{size:16})}),t.jsx(b,{"aria-label":"Interrupt",onClick:l,...Xn,children:t.jsx(R,{size:16})})]})]})}),t.jsx(p,{...Jn,children:t.jsxs(a,{direction:"row",gap:"2",p:"2",children:[t.jsx(T,{value:r,onChange:n,onKeyDown:o,onCompositionStart:s,onCompositionEnd:i,placeholder:"Type your message...",...Yn}),t.jsx(P,{onClick:d,...Qn,children:t.jsx(D,{size:16})})]})})]})}):null}const ro=h.forwardRef(((e,r)=>{const{startElement:n,startElementProps:o,endElement:s,endElementProps:i,children:a,startOffset:l="6px",endOffset:c="6px",...d}=e,u=h.Children.only(a);return t.jsxs(L,{ref:r,...d,children:[n&&t.jsx(z,{pointerEvents:"none",...o,children:n}),h.cloneElement(u,{...n&&{ps:`calc(var(--input-height) - ${l})`},...s&&{pe:`calc(var(--input-height) - ${c})`},...a.props}),s&&t.jsx(z,{placement:"end",...i,children:s})]})})),no=(window.api,{container:{align:"stretch",gap:4,p:0},field:{label:{color:"gray.700",fontWeight:"500"}},select:{root:{colorPalette:"blue",bg:"white"},trigger:{bg:"gray.50",borderColor:"gray.300",_focus:{borderColor:"blue.400"}}},input:{bg:"gray.50",borderColor:"gray.300",color:"gray.800",_placeholder:{color:"gray.500"},_focus:{bg:"white",borderColor:"blue.400",color:"gray.800"}},buttonGroup:{gap:2,width:"100%"},button:{width:"50%",variant:"outline",colorPalette:"blue"},fieldLabel:{fontSize:"sm",color:"gray.700",fontWeight:"500"}}),oo={field:{orientation:"horizontal"},fieldLabel:{fontSize:"sm",color:"gray.700",fontWeight:"500",whiteSpace:"nowrap"},switch:{size:"md",colorPalette:"blue",variant:"solid"},numberInput:{root:{pattern:"[0-9]*\\.?[0-9]*",inputMode:"decimal"},input:{bg:"gray.50",borderColor:"gray.300",color:"gray.800",_placeholder:{color:"gray.500"},_focus:{bg:"white",borderColor:"blue.400",color:"gray.800"}}},container:{gap:4,maxW:"lg",css:{"--field-label-width":"120px"}},input:{bg:"gray.50",borderColor:"gray.300",color:"gray.800",_placeholder:{color:"gray.500"},_focus:{bg:"white",borderColor:"blue.400",color:"gray.800"}},select:{root:{colorPalette:"blue",bg:"white"},trigger:{bg:"gray.50",borderColor:"gray.300",color:"gray.800",_placeholder:{color:"gray.500"},_focus:{borderColor:"blue.400",bg:"white",color:"gray.800"}}}},so={container:{gap:4,maxW:"lg",css:{"--field-label-width":"120px"}},emotionMap:{title:{fontWeight:"600",mb:3,color:"gray.800",fontSize:"md"},entry:{mb:2,p:2,bg:"gray.50",borderRadius:"md",border:"1px solid",borderColor:"gray.200"},button:{colorPalette:"blue",size:"sm",variant:"solid"},deleteButton:{colorPalette:"red",size:"sm",variant:"outline"}}},io=h.forwardRef(((e,r)=>{const{label:n,children:o,helperText:s,errorText:i,optionalText:a,...l}=e;return t.jsxs(U,{ref:r,...l,children:[n&&t.jsxs(_,{children:[n,t.jsx($,{fallback:a})]}),o,s&&t.jsx(O,{children:s}),i&&t.jsx(F,{children:i})]})})),ao=h.forwardRef(((e,r)=>{const{inputProps:n,children:o,rootRef:s,trackLabel:i,thumbLabel:a,...l}=e;return t.jsxs(B,{ref:s,...l,children:[t.jsx(N,{ref:r,...n}),t.jsxs(W,{children:[t.jsx(H,{children:a&&t.jsx(V,{fallback:a?.off,children:a?.on})}),i&&t.jsx(G,{fallback:i.off,children:i.on})]}),null!=o&&t.jsx(q,{children:o})]})})),lo=h.forwardRef(((e,r)=>t.jsx(b,{variant:"ghost","aria-label":"Close",ref:r,...e,children:e.children??t.jsx(S,{})}))),co=h.forwardRef(((e,r)=>{const{children:n,clearable:o,...s}=e;return t.jsxs(K,{...s,children:[t.jsx(X,{ref:r,children:n}),t.jsxs(J,{children:[o&&t.jsx(uo,{}),t.jsx(Y,{})]})]})})),uo=h.forwardRef(((e,r)=>t.jsx(Q,{asChild:!0,...e,ref:r,children:t.jsx(lo,{size:"xs",variant:"plain",focusVisibleRing:"inside",focusRingWidth:"2px",pointerEvents:"auto"})}))),ho=h.forwardRef(((e,n)=>{const{portalled:o=!0,portalRef:s,...i}=e;return t.jsx(r,{disabled:!o,container:s,children:t.jsx(Z,{children:t.jsx(ee,{...i,ref:n})})})})),go=h.forwardRef(((e,r)=>{const{item:n,children:o,...s}=e;return t.jsxs(te,{item:n,...s,ref:r,children:[o,t.jsx(re,{})]},n.value)})),po=h.forwardRef(((e,r)=>{const{children:n,...o}=e;return t.jsx(ne,{...o,ref:r,children:t.jsx(oe,{children:t=>{const r=t.selectedItems;return 0===r.length?e.placeholder:n?n(r):1===r.length?t.collection.stringifyItem(r[0]):`${r.length} selected`}})})})),mo=h.forwardRef(((e,r)=>t.jsx(se,{...e,ref:r,positioning:{sameWidth:!0,...e.positioning},children:e.asChild?e.children:t.jsxs(t.Fragment,{children:[t.jsx(ie,{}),e.children]})})));function fo({label:e,value:r,onChange:n,collection:o,placeholder:s}){return t.jsx(io,{...no.field,label:t.jsx(f,{...no.field.label,children:e}),children:t.jsxs(mo,{...no.select.root,collection:o,value:r,onValueChange:e=>n(e.value),children:[t.jsx(co,{...no.select.trigger,style:{color:"#2D3748"},children:t.jsx(po,{placeholder:s,style:{color:"#2D3748"}})}),t.jsx(ho,{children:o.items.map((e=>t.jsx(go,{item:e,children:e.label},e.value)))})]})})}function xo({label:e,value:r,onChange:n,min:o,max:s,step:i,allowMouseWheel:a}){return t.jsx(io,{...oo.field,label:t.jsx(f,{...oo.fieldLabel,children:e}),children:t.jsxs(ce,{...oo.numberInput.root,value:r.toString(),onValueChange:e=>n(e.value),min:o,max:s,step:i,allowMouseWheel:a,children:[t.jsx(de,{...oo.numberInput.input,style:{color:"#2D3748"}}),t.jsxs(ue,{children:[t.jsx(he,{}),t.jsx(ge,{})]})]})})}function bo({label:e,checked:r,onChange:n}){return t.jsx(io,{...oo.field,label:t.jsx(f,{...oo.fieldLabel,children:e}),children:t.jsx(ao,{...oo.switch,checked:r,onCheckedChange:e=>n(e.checked)})})}function wo({label:e,value:r,onChange:n,placeholder:o}){return t.jsx(io,{...no.field,label:t.jsx(f,{...no.field.label,children:e}),children:t.jsx(T,{...no.input,placeholder:o,value:r,onChange:e=>n(e.target.value),style:{color:"#2D3748"}})})}h.forwardRef(((e,r)=>{const{children:n,label:o,...s}=e;return t.jsxs(ae,{...s,ref:r,children:[t.jsx(le,{children:o}),n]})}));function vo({onSave:e,onCancel:r}){const n=Ar(),{confName:o,setConfName:s}=Fr(),{wsUrl:i,setWsUrl:l,baseUrl:c,setBaseUrl:d}=jr(),u=(()=>{const{backgroundFiles:e}=Ar()||{},{configFiles:t}=Fr();return{languages:pe({items:[{label:"English",value:"en"},{label:"中文",value:"zh"}]}),backgrounds:pe({items:e?.map((e=>({label:String(e),value:`/bg/${e}`})))||[]}),characterPresets:pe({items:t.map((e=>({label:e.name,value:e.filename})))})}})(),{settings:g,handleSettingChange:p,handleCameraToggle:m,handleCharacterPresetChange:f,showSubtitle:x,setShowSubtitle:b}=(({bgUrlContext:e,confName:t,setConfName:r,baseUrl:n,wsUrl:o,onWsUrlChange:s,onBaseUrlChange:i,onSave:a,onCancel:l})=>{const{showSubtitle:c,setShowSubtitle:d}=Pr(),{setUseCameraBackground:u}=e||{},{startBackgroundCamera:g,stopBackgroundCamera:p}=ir(),{configFiles:m,getFilenameByName:f}=Fr(),{switchCharacter:x}=hn(),b={language:["en"],customBgUrl:e?.backgroundUrl?.includes("/bg/")?"":e?.backgroundUrl||"",selectedBgUrl:(()=>{if(!e?.backgroundUrl)return[];const t=e.backgroundUrl.replace(n,"");return t.startsWith("/bg/")?[t]:[]})(),backgroundUrl:e?.backgroundUrl||"",selectedCharacterPreset:[],useCameraBackground:e?.useCameraBackground||!1,wsUrl:o||Cr,baseUrl:n||Sr,showSubtitle:c},[w,v]=h.useState(b),[y,j]=h.useState(b),C=t;h.useEffect((()=>{d(w.showSubtitle);const t=w.customBgUrl||w.selectedBgUrl[0];if(t&&e){const r=t.startsWith("http")?t:`${n}${t}`;e.setBackgroundUrl(r)}s(w.wsUrl),i(w.baseUrl)}),[w]),h.useEffect((()=>{if(t){const e={...w,selectedCharacterPreset:[t]};v(e),j(e)}}),[t]),h.useEffect((()=>{if(!a||!l)return;const e=a((()=>{k()})),t=l((()=>{E()}));return()=>{e?.(),t?.()}}),[a,l]);const S=(e,t)=>{v((r=>({...r,[e]:t}))),"wsUrl"===e&&s(t),"baseUrl"===e&&i(t)},k=()=>{j(w)},E=()=>{v(y),d(y.showSubtitle),e&&(e.setBackgroundUrl(y.backgroundUrl),e.setUseCameraBackground(y.useCameraBackground)),s(y.wsUrl),i(y.baseUrl),C&&r(C),y.useCameraBackground?g():p()};return{settings:w,handleSettingChange:S,handleSave:k,handleCancel:E,handleCameraToggle:async e=>{if(u)if(e)try{await g(),S("useCameraBackground",!0),u(!0)}catch(t){console.error("Failed to start camera:",t),S("useCameraBackground",!1),u(!1)}else p(),S("useCameraBackground",!1),u(!1)},handleCharacterPresetChange:e=>{const r=e[0],n=m.find((e=>e.filename===r)),o=t?f(t):"";S("selectedCharacterPreset",e),o!==r&&n&&x(r)},showSubtitle:c,setShowSubtitle:d}})({bgUrlContext:n,confName:o,setConfName:s,baseUrl:c,wsUrl:i,onWsUrlChange:l,onBaseUrlChange:d,onSave:e,onCancel:r});return t.jsxs(a,{...oo.container,children:[t.jsx(fo,{label:"🌐 言語 / Language",value:g.language,onChange:e=>p("language",e),collection:u.languages,placeholder:"言語を選択 / Select language"}),t.jsx(bo,{label:"📷 カメラ背景を使用",checked:g.useCameraBackground,onChange:m}),t.jsx(bo,{label:"📝 字幕を表示",checked:x,onChange:b}),!g.useCameraBackground&&t.jsxs(t.Fragment,{children:[n?.backgroundFiles?.length>0&&t.jsx(fo,{label:"🖼️ 背景画像",value:g.selectedBgUrl,onChange:e=>p("selectedBgUrl",e),collection:u.backgrounds,placeholder:"利用可能な背景から選択"}),t.jsx(wo,{label:"🔗 カスタム背景URL",value:g.customBgUrl,onChange:e=>p("customBgUrl",e),placeholder:"画像URLを入力"})]}),t.jsx(fo,{label:"👤 キャラクタープリセット",value:g.selectedCharacterPreset,onChange:f,collection:u.characterPresets,placeholder:o||"キャラクターを選択"}),t.jsx(wo,{label:"🔌 WebSocket URL",value:g.wsUrl,onChange:e=>p("wsUrl",e),placeholder:"WebSocket URLを入力"}),t.jsx(wo,{label:"🌐 ベースURL",value:g.baseUrl,onChange:e=>p("baseUrl",e),placeholder:"ベースURLを入力"})]})}function yo({onSave:e,onCancel:r}){const{modelInfo:n,handleInputChange:o,handleSave:s,handleCancel:i}=(()=>{const e=Vr(),t={url:"",kScale:.5,initialXshift:0,initialYshift:0,emotionMap:{},scrollToResize:!0},[r,n]=h.useState(e?.modelInfo||t),[o,s]=h.useState(e?.modelInfo||t);return h.useEffect((()=>{e?.modelInfo&&JSON.stringify(e.modelInfo)!==JSON.stringify(o)&&(s(e.modelInfo),n(e.modelInfo))}),[e?.modelInfo]),h.useEffect((()=>{e&&r&&e.setModelInfo(r)}),[r.pointerInteractive,r.scrollToResize,r.emotionMap]),{modelInfo:r,handleInputChange:(e,t)=>{n((r=>({...r,[e]:t})))},handleSave:()=>{e&&r&&s(r)},handleCancel:()=>{n(o),e&&o&&e.setModelInfo(o)}}})(),[l,c]=h.useState(""),[d,u]=h.useState("");h.useEffect((()=>{if(!e||!r)return;const t=e(s),n=r(i);return()=>{t?.(),n?.()}}),[e,r]);return t.jsxs(a,{...so.container,children:[t.jsx(bo,{label:"📱 ポインターインタラクティブ",checked:n.pointerInteractive??!1,onChange:e=>o("pointerInteractive",e)}),t.jsx(bo,{label:"🔍 スクロールでサイズ変更を有効化",checked:n.scrollToResize??!0,onChange:e=>o("scrollToResize",e)}),t.jsxs(k,{align:"stretch",gap:4,mt:6,children:[t.jsx(f,{...so.emotionMap.title,children:"🎭 表情マッピング設定"}),t.jsx(P,{onClick:()=>{o("emotionMap",{neutral:0,anger:1,disgust:1,fear:1,joy:2,smirk:5,sadness:4,surprise:3})},size:"sm",variant:"solid",colorScheme:"blue",children:"🧛‍♀️ バンパイアプリンセスの表情設定"}),Object.entries(n.emotionMap||{}).map((([e,r])=>t.jsxs(me,{...so.emotionMap.entry,children:[t.jsx(f,{flex:1,fontSize:"sm",children:e}),t.jsx(f,{fontSize:"sm",color:"gray.600",children:"→"}),t.jsx(f,{fontSize:"sm",fontWeight:"bold",children:r}),t.jsx(P,{size:"xs",variant:"outline",colorScheme:"red",onClick:()=>(e=>{const t={...n.emotionMap};delete t[e],o("emotionMap",t)})(e),children:"删除"})]},e))),t.jsxs(k,{gap:2,align:"stretch",children:[t.jsx(f,{fontSize:"sm",fontWeight:"medium",children:"新しい表情マッピングを追加:"}),t.jsxs(me,{children:[t.jsx(wo,{label:"",placeholder:"表情名 (例: joy)",value:l,onChange:c}),t.jsx(wo,{label:"",placeholder:"表情番号 (例: 2)",value:d,onChange:u}),t.jsx(P,{onClick:()=>{if(!l.trim()||!d.trim())return;const e=parseInt(d);if(isNaN(e))return;const t={...n.emotionMap,[l.trim()]:e};o("emotionMap",t),c(""),u("")},size:"sm",variant:"solid",colorScheme:"green",disabled:!l.trim()||!d.trim(),children:"追加"})]})]}),t.jsx(f,{fontSize:"xs",color:"gray.700",children:"💡 ヒント: 表情名はバックエンドから送信される表情文字列と一致させ、表情番号はLive2Dモデルの表情インデックスに対応します"})]})]})}function jo({onSave:e,onCancel:r}){const{localSettings:n,autoStopMic:o,autoStartMicOn:s,autoStartMicOnConvEnd:i,setAutoStopMic:l,setAutoStartMicOn:c,setAutoStartMicOnConvEnd:d,handleInputChange:u,handleSave:p,handleCancel:m}=(()=>{const{settings:e,updateSettings:t,autoStopMic:r,setAutoStopMic:n,autoStartMicOn:o,setAutoStartMicOn:s,autoStartMicOnConvEnd:i,setAutoStartMicOnConvEnd:a}=dn(),l=h.useRef(e),c=h.useRef(e),d=h.useRef(r),u=h.useRef(o),p=h.useRef(i),[m,f]=h.useState(r),[x,b]=h.useState(o),[w,v]=h.useState(i),[,y]=g.useReducer((e=>e+1),0);return h.useEffect((()=>{f(r),b(o),v(i)}),[r,o,i]),{localSettings:l.current,autoStopMic:m,autoStartMicOn:x,autoStartMicOnConvEnd:w,setAutoStopMic:e=>{f(e),n(e)},setAutoStartMicOn:e=>{b(e),s(e)},setAutoStartMicOnConvEnd:e=>{v(e),a(e)},handleInputChange:(e,t)=>{if(""===t||"-"===t)l.current={...l.current,[e]:t};else{const r=Number(t);isNaN(r)||(l.current={...l.current,[e]:r})}y()},handleSave:()=>{t(l.current),c.current=l.current,d.current=m,u.current=x,p.current=w},handleCancel:()=>{l.current=c.current,f(d.current),b(u.current),n(d.current),s(u.current),v(p.current),a(p.current),y()}}})();return h.useEffect((()=>{if(!e||!r)return;const t=e(p),n=r(m);return()=>{t?.(),n?.()}}),[e,r,p,m]),t.jsxs(a,{...oo.container,children:[t.jsx(bo,{label:"🎤 AI発話時にマイクを自動停止",checked:o,onChange:l}),t.jsx(bo,{label:"🗣️ 会話終了時にマイクを自動開始",checked:i,onChange:d}),t.jsx(bo,{label:"⏸️ AI中断時にマイクを自動開始",checked:s,onChange:c}),t.jsx(xo,{label:"📊 音声検出閾値",value:n.positiveSpeechThreshold,onChange:e=>u("positiveSpeechThreshold",e),min:1,max:100}),t.jsx(xo,{label:"🔇 無音検出閾値",value:n.negativeSpeechThreshold,onChange:e=>u("negativeSpeechThreshold",e),min:0,max:100}),t.jsx(xo,{label:"🔄 復元フレーム数",value:n.redemptionFrames,onChange:e=>u("redemptionFrames",e),min:1,max:100})]})}function Co(){return t.jsx(p,{children:"TTS Settings Content"})}function So(){const{sendMessage:e}=jr(),{captureAllMedia:t}=Yr();return{sendTriggerSignal:h.useCallback((async r=>{const n=await t();e({type:"ai-speak-signal",idle_time:r,images:n})}),[e,t])}}const ko={allowProactiveSpeak:!1,idleSecondsToSpeak:5,allowButtonTrigger:!1},Eo=h.createContext(null);function Ao({children:e}){const[r,n]=ar("proactiveSpeakSettings",ko),{aiState:o}=tn(),{sendTriggerSignal:s}=So(),i=h.useRef(null),a=h.useRef(null),l=h.useCallback((()=>{i.current&&(clearTimeout(i.current),i.current=null),a.current=null}),[]),c=h.useCallback((()=>{l(),r.allowProactiveSpeak&&(a.current=Date.now(),i.current=setTimeout((()=>{const e=(Date.now()-a.current)/1e3;s(e)}),1e3*r.idleSecondsToSpeak))}),[r.allowProactiveSpeak,r.idleSecondsToSpeak,s,l]);h.useEffect((()=>{o===Qr.IDLE?c():l()}),[o,c,l]),h.useEffect((()=>()=>{l()}),[l]);const d=h.useCallback((e=>{n(e)}),[n]),u=h.useMemo((()=>({settings:r,updateSettings:d})),[r,d]);return t.jsx(Eo.Provider,{value:u,children:e})}const Mo=()=>{const e=h.useContext(Eo);if(!e)throw new Error("useProactiveSpeak must be used within a ProactiveSpeakProvider");return e};function Io({onSave:e,onCancel:r}){const{settings:n,handleAllowProactiveSpeakChange:o,handleIdleSecondsChange:s,handleAllowButtonTriggerChange:i}=function({onSave:e,onCancel:t}={}){const{settings:r,updateSettings:n}=Mo(),[o,s]=h.useState({allowProactiveSpeak:r.allowProactiveSpeak,idleSecondsToSpeak:r.idleSecondsToSpeak,allowButtonTrigger:r.allowButtonTrigger}),[i,a]=h.useState({...r});h.useEffect((()=>{r&&(a(r),s(r))}),[r]);const l=h.useCallback((e=>{s((t=>({...t,allowProactiveSpeak:e})))}),[]),c=h.useCallback((e=>{s((t=>({...t,idleSecondsToSpeak:e})))}),[]),d=h.useCallback((e=>{s((t=>({...t,allowButtonTrigger:e})))}),[]),u=h.useCallback((()=>{n(o),a(o)}),[n,o]),g=h.useCallback((()=>{s(i),n(i)}),[i,n]);return h.useEffect((()=>{if(!e||!t)return;const r=e(u),n=t(g);return()=>{r?.(),n?.()}}),[e,t,u,g]),{settings:o,handleAllowProactiveSpeakChange:l,handleIdleSecondsChange:c,handleAllowButtonTriggerChange:d}}({onSave:e,onCancel:r});return t.jsxs(a,{...oo.container,children:[t.jsx(bo,{label:"🤖 AIが積極的に発話することを許可",checked:n.allowProactiveSpeak,onChange:o}),n.allowProactiveSpeak&&t.jsx(xo,{label:"⏱️ AIが発話するまでのアイドル秒数",value:n.idleSecondsToSpeak,onChange:e=>s(Number(e)),min:0,step:.1,allowMouseWheel:!0}),t.jsx(bo,{label:"🙋 手を挙げるボタンでAIに発話を促す",checked:n.allowButtonTrigger,onChange:i})]})}const Ro=h.forwardRef(((e,r)=>{const{title:n,children:o,icon:s,closable:i,onClose:a,startElement:l,endElement:c,...d}=e;return t.jsxs(fe,{ref:r,...d,children:[l||t.jsx(xe,{children:s}),o?t.jsxs(be,{children:[t.jsx(we,{children:n}),t.jsx(ve,{children:o})]}):t.jsx(we,{flex:"1",children:n}),c,i&&t.jsx(lo,{size:"sm",pos:"relative",top:"-2",insetEnd:"-2",alignSelf:"flex-start",onClick:a})]})})),To=h.forwardRef(((e,r)=>{const{loading:n,disabled:o,loadingText:i,children:a,...l}=e;return t.jsx(P,{disabled:n||o,ref:r,...l,children:n&&!i?t.jsxs(t.Fragment,{children:[t.jsx(ye,{display:"inline-flex",children:t.jsx(s,{size:"inherit",color:"inherit"})}),t.jsx(je,{opacity:0,children:a})]}):n&&i?t.jsxs(t.Fragment,{children:[t.jsx(s,{size:"inherit",color:"inherit"}),i]}):a})})),Po=h.forwardRef(((e,r)=>{const{startElement:n,endElement:o,onClose:s,closable:i=!!s,children:a,...l}=e;return t.jsxs(Ce,{ref:r,...l,children:[n&&t.jsx(Se,{children:n}),t.jsx(ke,{children:a}),o&&t.jsx(Ee,{children:o}),i&&t.jsx(Ee,{children:t.jsx(Ae,{onClick:s})})]})})),Do=h.forwardRef(((e,n)=>{const{showArrow:o,children:s,disabled:i,portalled:a,content:l,contentProps:c,portalRef:d,...u}=e;return i?s:t.jsxs(Me,{...u,children:[t.jsx(Ie,{asChild:!0,children:s}),t.jsx(r,{disabled:!a,container:d,children:t.jsx(Re,{children:t.jsxs(Te,{ref:n,...c,children:[o&&t.jsx(Pe,{children:t.jsx(De,{})}),l]})})})]})}));var Lo=(e=>(e.MUTED="muted",e.AUDIO="audio",e.AUDIO_VAD="audio_vad",e))(Lo||{});const zo={audioMode:"audio_vad",autoSwitchNext:!0,cleanPlaybackExperience:!0,supportAnyLength:!0};function Uo({onSave:e,onCancel:r}){const{handleAudioModeChange:n,isMutedMode:o,isAudioMode:i,isAudioVADMode:a}=(({onSave:e,onCancel:t}={})=>{const[r,n]=ar("advertisementAudioSettings",zo),[o,s]=h.useState(r),[i,a]=h.useState(r);h.useEffect((()=>{a(r),s(r)}),[r]);const l=h.useCallback((e=>{s((t=>({...t,audioMode:e})))}),[]),c=h.useCallback((()=>{n(o),a(o),console.log("💾 广告音频设置已保存:",o)}),[o,n]),d=h.useCallback((()=>{s(i),console.log("↩️ 广告音频设置已取消，恢复到:",i)}),[i]);h.useEffect((()=>{if(!e||!t)return;const r=e(c),n=t(d);return()=>{r?.(),n?.()}}),[e,t,c,d]);const u="muted"!==o.audioMode,g="audio_vad"===o.audioMode;return{settings:o,persistedSettings:r,originalSettings:i,isAudioEnabled:u,isVADEnabled:g,handleAudioModeChange:l,handleSave:c,handleCancel:d,isMutedMode:"muted"===o.audioMode,isAudioMode:"audio"===o.audioMode,isAudioVADMode:"audio_vad"===o.audioMode}})({onSave:e,onCancel:r}),[l,c]=h.useState("ads"),[d,u]=h.useState([]),[g,m]=h.useState([]),[x,b]=h.useState(!0),[w,v]=h.useState(!1),[y,j]=h.useState(0),[C,S]=h.useState(null),A=h.useRef(null),M=fr(),I=(e,t)=>{S({type:e,text:t}),setTimeout((()=>S(null)),5e3)},R=async()=>{try{b(!0);const e=await fetch(`${M.baseUrl}/api/ads`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();console.log("📂 広告リスト取得:",t),u(t.advertisements||[])}catch(e){console.error("❌ 広告リスト取得失敗:",e),I("error",`広告リスト取得失敗: ${String(e)}`),u([])}finally{b(!1)}},D=async e=>{const t=new FormData;t.append("file",e);try{v(!0),j(0);const e=setInterval((()=>{j((e=>Math.min(e+10,90)))}),200),r=await fetch(`${M.baseUrl}/api/ads/upload`,{method:"POST",body:t});if(clearInterval(e),j(100),!r.ok){const e=await r.json();throw new Error(e.error||`HTTP ${r.status}`)}const n=await r.json();console.log("📤 広告アップロード成功:",n),I("success",n.message),await R(),window.dispatchEvent(new CustomEvent("advertisementListChanged",{detail:{action:"upload",filename:n.file_info?.filename}}))}catch(r){console.error("❌ 広告アップロード失敗:",r),I("error",`アップロード失敗: ${String(r)}`)}finally{v(!1),j(0)}},L=e=>{const t=xr("ads",e.filename);window.open(t,"_blank")},z=async()=>{try{b(!0);const e=await fetch(`${M.baseUrl}/api/videos`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();console.log("📂 获取洗衣机视频列表:",t),m(t.videos||[])}catch(e){console.error("❌ 获取洗衣机视频列表失败:",e),I("error",`获取洗衣机视频列表失败: ${String(e)}`),m([])}finally{b(!1)}},U=async e=>{const t=new FormData;t.append("file",e);try{v(!0),j(0);const e=setInterval((()=>{j((e=>Math.min(e+10,90)))}),200),r=await fetch(`${M.baseUrl}/api/videos/upload`,{method:"POST",body:t});if(clearInterval(e),j(100),!r.ok){const e=await r.json();throw new Error(e.error||`HTTP ${r.status}`)}const n=await r.json();console.log("📤 上传洗衣机视频成功:",n),I("success",n.message),await z(),window.dispatchEvent(new CustomEvent("laundryVideoListChanged",{detail:{action:"upload",filename:n.file_info?.filename}}))}catch(r){console.error("❌ 上传洗衣机视频失败:",r),I("error",`上传失败: ${String(r)}`)}finally{v(!1),j(0)}},_=e=>{const t=xr("videos",e.filename);window.open(t,"_blank")},$=()=>"ads"===l?d:g;return h.useEffect((()=>{"ads"===l?R():z()}),[l]),h.useEffect((()=>{R()}),[]),t.jsxs(p,{...oo.container,children:[t.jsxs(me,{mb:6,gap:2,width:"full",children:[t.jsx(P,{variant:"ads"===l?"solid":"ghost",colorPalette:"blue",onClick:()=>c("ads"),size:"md",borderRadius:"lg",flex:1,fontWeight:"500",children:"🎬 広告動画"}),t.jsx(P,{variant:"videos"===l?"solid":"ghost",colorPalette:"blue",onClick:()=>c("videos"),size:"md",borderRadius:"lg",flex:1,fontWeight:"500",children:"🧺 洗濯チュートリアル"})]}),"ads"===l&&t.jsxs(p,{mb:4,p:4,borderWidth:1,borderRadius:"md",bg:"blue.50",borderColor:"blue.200",children:[t.jsx(Le,{size:"md",mb:3,color:"blue.700",fontWeight:"600",children:"🎵 広告再生設定"}),t.jsxs(k,{align:"stretch",gap:4,children:[t.jsxs(p,{children:[t.jsx(f,{fontWeight:"bold",mb:2,children:"オーディオ再生モード"}),t.jsxs(me,{children:[t.jsx(P,{size:"sm",variant:o?"solid":"outline",colorScheme:"gray",title:"ミュート再生モード - 音声を出力しません",onClick:()=>n(Lo.MUTED),children:"🔇 ミュートモード"}),t.jsx(P,{size:"sm",variant:a?"solid":"outline",colorScheme:"blue",title:"音声再生モード + インテリジェントVAD調整",onClick:()=>n(Lo.AUDIO_VAD),children:"🎵 音声+VADモード"}),t.jsx(P,{size:"sm",variant:i?"solid":"outline",colorScheme:"blue",title:"音声再生モード - 通常のオーディオ再生",onClick:()=>n(Lo.AUDIO),children:"🎵 音声モード"})]}),t.jsxs(f,{fontSize:"sm",color:"gray.800",mt:2,children:["• ミュートモード：広告をミュートで再生、音声認識に影響しません",t.jsx("br",{}),"• 音声モード：広告を通常の音声で再生",t.jsx("br",{}),"• 音声+VADモード：音声を再生し、音声検出感度をインテリジェントに調整"]})]}),t.jsxs(p,{children:[t.jsx(f,{fontWeight:"bold",mb:2,children:"再生動作"}),t.jsxs(k,{align:"start",gap:2,children:[t.jsx(f,{fontSize:"sm",color:"green.600",children:"✅ 動画再生完了後に自動的に次へ切り替え"}),t.jsx(f,{fontSize:"sm",color:"green.600",children:"✅ クリーンな再生体験、インターフェースの遮蔽なし"}),t.jsx(f,{fontSize:"sm",color:"gray.800",children:"✅ 任意の長さの広告動画をサポート"})]})]}),t.jsx(p,{p:3,bg:"white",borderRadius:"md",border:"1px solid",borderColor:"gray.200",children:t.jsx(f,{fontSize:"sm",color:"gray.800",children:"💡 すべての広告制御機能を再生画面からこの設定パネルに移動し、視聴時の完全な無干渉を保証"})})]})]}),C&&t.jsx(p,{mb:4,children:t.jsx(Ro,{status:C.type,title:"error"===C.type?"エラー":"success"===C.type?"成功":"ヒント",children:C.text})}),t.jsxs(p,{mb:4,p:4,borderWidth:1,borderRadius:"md",borderColor:"gray.200",children:[t.jsxs(Le,{size:"md",mb:4,color:"gray.700",fontWeight:"600",children:["📤 新しい","ads"===l?"広告":"洗濯機チュートリアル","をアップロード"]}),t.jsxs(p,{border:"2px dashed",borderColor:"gray.300",borderRadius:"md",p:6,textAlign:"center",cursor:"pointer",_hover:{borderColor:"blue.400",bg:"blue.50"},onDragOver:e=>{e.preventDefault()},onDrop:e=>{e.preventDefault();const t=Array.from(e.dataTransfer.files).find((e=>e.type.startsWith("video/")));t?"ads"===l?D(t):U(t):I("error","请拖拽视频文件，只支持视频格式文件")},onClick:()=>A.current?.click(),children:[t.jsx(T,{ref:A,type:"file",accept:"video/*",onChange:e=>{const t=e.target.files?.[0];if(t){if(!["video/mp4","video/avi","video/mov","video/webm","video/x-msvideo"].includes(t.type))return void I("error","请选择 MP4、AVI、MOV 或 WebM 格式的视频文件");const e="ads"===l?524288e3:1073741824,r="ads"===l?"500MB":"1GB";if(t.size>e)return void I("error",`文件大小不能超过 ${r}，当前文件: ${(t.size/1048576).toFixed(1)}MB`);"ads"===l?D(t):U(t)}A.current&&(A.current.value="")},display:"none"}),w?t.jsxs(k,{children:[t.jsx(s,{size:"lg",color:"blue.500"}),t.jsx(f,{fontWeight:"bold",children:"アップロード中..."}),t.jsx(p,{width:"200px",height:"8px",bg:"gray.200",borderRadius:"md",children:t.jsx(p,{width:`${y}%`,height:"100%",bg:"blue.500",borderRadius:"md",transition:"width 0.3s"})}),t.jsxs(f,{fontSize:"sm",color:"gray.800",children:[y,"%"]})]}):t.jsxs(k,{children:[t.jsx(f,{fontSize:"3xl",children:"📁"}),t.jsx(f,{fontWeight:"bold",children:"ここをクリックまたは動画ファイルをドラッグ"}),t.jsx(f,{fontSize:"sm",color:"gray.800",children:"対応形式: MP4, AVI, MOV, WebM | 最大サイズ: 500MB"})]})]})]}),t.jsxs(p,{p:4,borderWidth:1,borderRadius:"md",borderColor:"gray.200",children:[t.jsxs(me,{mb:4,children:[t.jsxs(Le,{size:"md",children:["📋 ","ads"===l?"广告":"洗衣机教程","列表"]}),t.jsx(ze,{}),t.jsx(To,{size:"sm",onClick:()=>{"ads"===l?R():z()},loading:x,variant:"outline",children:"🔄 刷新"})]}),x?t.jsx(E,{justify:"center",p:8,children:t.jsx(s,{size:"lg"})}):0===$().length?t.jsxs(Ro,{status:"info",title:"暂无"+("ads"===l?"广告视频":"洗衣机教程视频"),children:["请上传第一个","ads"===l?"广告视频开始使用轮播功能":"洗衣机教程视频"]}):t.jsx(k,{align:"stretch",children:$().map((e=>{return t.jsx(p,{p:4,borderWidth:1,borderRadius:"md",borderColor:"gray.300",bg:"white",children:t.jsxs(me,{children:[t.jsxs(p,{flex:1,children:[t.jsxs(me,{mb:2,children:[t.jsx(f,{fontWeight:"bold",fontSize:"lg",color:"gray.800",children:e.name}),t.jsx(Po,{variant:"subtle",color:"gray.700",bg:"gray.100",children:e.format}),e.machine_id&&t.jsxs(Po,{colorScheme:"green",variant:"subtle",children:["マシン ",e.machine_id]})]}),t.jsxs(f,{fontSize:"sm",color:"gray.800",mb:1,children:["ファイル名: ",e.filename]}),t.jsxs(f,{fontSize:"sm",color:"gray.800",children:["サイズ: ",(r=e.size_bytes,r<1048576?`${(r/1024).toFixed(1)} KB`:`${(r/1048576).toFixed(1)} MB`)]})]}),t.jsxs(me,{children:[t.jsx(Do,{content:"動画プレビュー",children:t.jsx(P,{size:"sm",colorScheme:"blue",variant:"ghost",onClick:()=>{"ads"===l?L(e):_(e)},children:"👁️"})}),t.jsx(Do,{content:"動画削除",children:t.jsx(P,{size:"sm",colorScheme:"red",variant:"ghost",onClick:()=>{"ads"===l?(async e=>{if(confirm(`确定要删除广告 "${e}" 吗？此操作不可撤销！`))try{const t=await fetch(`${M.baseUrl}/api/ads/${encodeURIComponent(e)}`,{method:"DELETE"});if(!t.ok){const e=await t.json();throw new Error(e.error||`HTTP ${t.status}`)}const r=await t.json();console.log("🗑️ 删除广告成功:",r),I("success",r.message),await R(),window.dispatchEvent(new CustomEvent("advertisementListChanged",{detail:{action:"delete",filename:e}}))}catch(t){console.error("❌ 删除广告失败:",t),I("error",`删除失败: ${String(t)}`)}})(e.filename):(async e=>{if(confirm(`确定要删除洗衣机教程视频 "${e}" 吗？此操作不可撤销！`))try{const t=await fetch(`${M.baseUrl}/api/videos/${encodeURIComponent(e)}`,{method:"DELETE"});if(!t.ok){const e=await t.json();throw new Error(e.error||`HTTP ${t.status}`)}const r=await t.json();console.log("🗑️ 删除洗衣机视频成功:",r),I("success",r.message),await z(),window.dispatchEvent(new CustomEvent("laundryVideoListChanged",{detail:{action:"delete",filename:e}}))}catch(t){console.error("❌ 删除洗衣机视频失败:",t),I("error",`删除失败: ${String(t)}`)}})(e.filename)},children:"🗑️"})})]})]})},e.id);var r}))})]}),$().length>0&&t.jsxs(p,{mt:4,p:4,borderWidth:1,borderRadius:"md",children:[t.jsx(Le,{size:"sm",mb:3,children:"📊 统计信息"}),t.jsxs(me,{children:[t.jsxs(k,{children:[t.jsx(f,{fontSize:"2xl",fontWeight:"bold",color:"blue.500",children:$().length}),t.jsx(f,{fontSize:"sm",color:"gray.800",children:"総動画数"})]}),t.jsx(p,{mx:8,height:"50px",borderLeft:"1px solid",borderColor:"gray.300"}),t.jsxs(k,{children:[t.jsxs(f,{fontSize:"2xl",fontWeight:"bold",color:"green.500",children:[($().reduce(((e,t)=>e+t.size_bytes),0)/1048576).toFixed(1),"MB"]}),t.jsx(f,{fontSize:"sm",color:"gray.800",children:"総サイズ"})]})]})]})]})}function _o(){return t.jsx(p,{children:"About Settings Content"})}const $o=h.forwardRef(((e,r)=>{const{name:n,src:o,srcSet:s,loading:i,icon:a,fallback:l,children:c,...d}=e;return t.jsxs(Ue,{ref:r,...d,children:[t.jsx(Oo,{name:n,icon:a,children:l}),t.jsx(_e,{src:o,srcSet:s,loading:i}),c]})})),Oo=h.forwardRef(((e,r)=>{const{name:n,icon:o,children:s,...i}=e;return t.jsxs($e,{ref:r,...i,children:[s,null!=n&&null==s&&t.jsx(t.Fragment,{children:Fo(n)}),null==n&&null==s&&t.jsx(Oe,{asChild:!!o,children:o})]})}));function Fo(e){const t=e.trim().split(" "),r=null!=t[0]?t[0]:"",n=t.length>1?t[t.length-1]:"";return r&&n?`${r.charAt(0)}${n.charAt(0)}`:r.charAt(0)}const Bo=h.forwardRef(((e,r)=>{const{size:n,variant:o,borderless:s,...i}=e;return t.jsx(Fe,{value:{size:n,variant:o,borderless:s},children:t.jsx(L,{gap:"0",spaceX:"-3",ref:r,...i})})}));function No({message:e,isSelected:r,onClick:n}){const o="ai"===e.role;return t.jsx(p,{onClick:n,cursor:"pointer",bg:r?"gray.100":"transparent",_hover:{bg:"gray.50"},p:2,borderRadius:"md",transition:"background-color 0.2s",children:t.jsxs(E,{gap:3,children:[t.jsx(Bo,{children:t.jsx($o,{size:"sm",name:e.name||(o?"AI":"Me"),bg:o?"blue.500":"green.500",color:"white"})}),t.jsxs(p,{flex:1,children:[t.jsx(f,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:e.name||(o?"AI":"Me")}),t.jsx(f,{fontSize:"sm",color:"gray.600",truncate:!0,children:(s=e.content,s.replace(/\[[\w\s]*\]/g,"").trim())}),t.jsx(f,{fontSize:"xs",color:"gray.400",mt:1,children:new Date(e.timestamp).toLocaleTimeString()})]})]})});var s}const Wo=void 0!==window.api,Ho={scrollbar:{"&::-webkit-scrollbar":{width:"4px"},"&::-webkit-scrollbar-track":{bg:"whiteAlpha.100",borderRadius:"full"},"&::-webkit-scrollbar-thumb":{bg:"whiteAlpha.300",borderRadius:"full"}},panel:{border:"1px solid",borderColor:"whiteAlpha.200",borderRadius:"lg",bg:"blackAlpha.400"},title:{fontSize:"lg",fontWeight:"semibold",color:"white",mb:4}},Vo={sidebar:{container:e=>({position:"absolute",left:0,top:0,height:"100%",width:"440px",bg:"gray.900",transform:e?"translateX(calc(-100% + 24px))":"translateX(0)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",display:"flex",flexDirection:"column",gap:4,overflow:e?"visible":"hidden",pb:"4"}),toggleButton:{position:"absolute",right:0,top:0,width:"24px",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"whiteAlpha.700",_hover:{color:"white"},bg:"transparent",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",zIndex:1},content:{flex:1,width:"100%",display:"flex",flexDirection:"column",gap:4,overflow:"hidden"},header:{width:"100%",display:"flex",alignItems:"center",gap:1,p:2}},chatHistoryPanel:{container:{flex:1,overflow:"hidden",px:4,display:"flex",flexDirection:"column"},title:Ho.title,messageList:{...Ho.panel,p:4,width:"97%",flex:1,overflowY:"auto",css:{...Ho.scrollbar,scrollPaddingBottom:"1rem"},display:"flex",flexDirection:"column",gap:2}},systemLogPanel:{container:{width:"100%",overflow:"hidden",px:4,minH:"200px",marginTop:"auto"},title:Ho.title,logList:{...Ho.panel,p:4,height:"200px",overflowY:"auto",fontFamily:"mono",css:Ho.scrollbar},entry:{p:2,borderRadius:"md",_hover:{bg:"whiteAlpha.50"}}},chatBubble:{container:{display:"flex",position:"relative",_hover:{bg:"whiteAlpha.50"},py:1,px:2,borderRadius:"md"},message:{maxW:"90%",bg:"transparent",p:2},text:{fontSize:"xs",color:"whiteAlpha.900"},dot:{position:"absolute",w:"2",h:"2",borderRadius:"full",bg:"white",top:"2"}},historyDrawer:{listContainer:{flex:1,overflowY:"auto",px:4,py:2,css:Ho.scrollbar},historyItem:{mb:4,p:3,borderRadius:"md",bg:"whiteAlpha.50",cursor:"pointer",transition:"all 0.2s",_hover:{bg:"whiteAlpha.100"}},historyItemSelected:{bg:"whiteAlpha.200",borderLeft:"3px solid",borderColor:"blue.500"},historyHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},timestamp:{fontSize:"sm",color:"whiteAlpha.700",fontFamily:"mono"},deleteButton:{variant:"ghost",colorScheme:"red",size:"sm",color:"red.300",opacity:.8,_hover:{opacity:1,bg:"whiteAlpha.200"}},messagePreview:{fontSize:"sm",color:"whiteAlpha.900",noOfLines:2,overflow:"hidden",textOverflow:"ellipsis"},drawer:{content:{background:"var(--chakra-colors-gray-900)",maxWidth:"440px",marginTop:Wo?"30px":"0",height:Wo?"calc(100vh - 30px)":"100vh"},title:{color:"white"},closeButton:{color:"white"},actionButton:{color:"white",borderColor:"white",variant:"outline"}}},cameraPanel:{container:{width:"97%",overflow:"hidden",px:4,minH:"240px"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},title:Ho.title,videoContainer:{...Ho.panel,width:"100%",height:"240px",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",transition:"all 0.2s"},video:{width:"100%",height:"100%",objectFit:"cover",transform:"scaleX(-1)",borderRadius:"8px",display:"block"}},screenPanel:{container:{width:"97%",overflow:"hidden",px:4,minH:"240px"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},title:Ho.title,screenContainer:{...Ho.panel,width:"100%",height:"240px",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",transition:"all 0.2s"},video:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"8px",display:"block"}},bottomTab:{container:{width:"97%",px:4,position:"relative",zIndex:0},tabs:{width:"100%",bg:"whiteAlpha.50",borderRadius:"lg",p:"1"},list:{borderBottom:"none",gap:"2"},trigger:{color:"whiteAlpha.700",display:"flex",alignItems:"center",gap:2,px:3,py:2,borderRadius:"md",_hover:{color:"white",bg:"whiteAlpha.50"},_selected:{color:"white",bg:"whiteAlpha.200"}}},groupDrawer:{section:{mb:6},sectionTitle:{fontSize:"lg",fontWeight:"semibold",color:"white",mb:3},inviteBox:{display:"flex",gap:2},input:{bg:"whiteAlpha.100",border:"none",color:"white",_placeholder:{color:"whiteAlpha.400"}},memberList:{display:"flex",flexDirection:"column",gap:2},memberItem:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2,borderRadius:"md",bg:"whiteAlpha.100"},memberText:{color:"white",fontSize:"sm"},removeButton:{size:"sm",color:"red.300",bg:"transparent",_hover:{bg:"whiteAlpha.200"}},button:{color:"white",bg:"whiteAlpha.100",_hover:{bg:"whiteAlpha.200"}},clipboardButton:{color:"white",bg:"transparent",_hover:{bg:"whiteAlpha.200"},size:"sm"}}},Go=Be`
  .cs-message-list {
    background: var(--chakra-colors-gray-900) !important;
    padding: var(--chakra-space-4);
  }
  
  .cs-message {
    margin: 12px 0;
    padding-top: 20px !important;
  }

  .cs-message__content {
    background-color: var(--chakra-colors-gray-700) !important;
    border-radius: var(--chakra-radii-md);
    padding: 8px !important;
    color: var(--chakra-colors-white) !important;
    font-size: 0.95rem !important;
    line-height: 1.5 !important;
    margin-top: 4px !important;
  }

  .cs-message__text {
    padding: 8px 0 !important;
  }

  .cs-message--outgoing .cs-message__content {
    background-color: var(--chakra-colors-gray-600) !important;
  }

  .cs-chat-container {
    background: transparent !important;
    border: 1px solid var(--chakra-colors-whiteAlpha-200);
    border-radius: var(--chakra-radii-lg);
    padding: var(--chakra-space-2);
  }

  .cs-main-container {
    border: none !important;
    background: transparent !important;
    width: calc(100% - 24px) !important;
    margin-left: 0 !important;
  }

  .cs-message__sender {
    position: absolute !important;
    top: 0 !important;
    left: 36px !important;
    font-size: 0.875rem !important;
    font-weight: 600 !important;
    color: var(--chakra-colors-whiteAlpha-900) !important;
  }

  .cs-message__content-wrapper {
    max-width: 80%;
    margin: 0 8px;
  }

  .cs-avatar {
    background-color: var(--chakra-colors-blue-500) !important;
    color: white !important;
    width: 28px !important;
    height: 28px !important;
    font-size: 14px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 50% !important;
  }

  .cs-message--outgoing .cs-avatar {
    background-color: var(--chakra-colors-green-500) !important;
  }

  .cs-message__header {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
`;function qo(){const{messages:e}=In(),{confName:r}=Fr(),{baseUrl:n}=jr(),o=e.filter((e=>e.content&&e.content.trim().length>0));return t.jsxs(p,{h:"full",overflow:"hidden",bg:"gray.900",children:[t.jsx(Ne,{styles:Go}),t.jsx(We,{children:t.jsx(He,{children:t.jsx(Ve,{children:0===o.length?t.jsx(p,{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",color:"whiteAlpha.500",fontSize:"sm",children:"No messages yet. Start a conversation!"}):o.map((e=>{return t.jsx(Ge,{model:{message:(o=e.content,o.replace(/\[[\w\s]*\]/g,"").trim()),sentTime:e.timestamp,sender:"ai"===e.role?e.name||r||"AI":"Me",direction:"ai"===e.role?"incoming":"outgoing",position:"single"},avatarPosition:"ai"===e.role?"tl":"tr",avatarSpacer:!1,children:t.jsx(qe,{children:"ai"===e.role?e.avatar?t.jsx("img",{src:`${n}/avatars/${e.avatar}`,alt:"avatar",style:{width:"100%",height:"100%",borderRadius:"50%"}}):e.name&&e.name[0].toUpperCase()||r&&r[0].toUpperCase()||"A":"Me"[0].toUpperCase()})},e.id);var o}))})})})]})}h.memo((({messages:e,messageListRef:r})=>{const n=h.useRef(null),o=h.useCallback((()=>{if(r.current){const{scrollHeight:e}=r.current,t=e-r.current.clientHeight;r.current.scrollTo({top:t+100,behavior:"smooth"})}}),[r]);return h.useEffect((()=>{o()}),[e,o]),h.useEffect((()=>{o()}),[o]),t.jsx(p,{...Vo.chatHistoryPanel.messageList,ref:r,children:e.map(((r,o)=>t.jsx(p,{ref:o===e.length-1?n:null,children:t.jsx(No,{message:r})},`${r.role}-${r.timestamp}-${r.id}`)))})})).displayName="MessageList";const Ko=h.forwardRef(((e,n)=>{const{children:o,portalled:s=!0,portalRef:i,offset:a,...l}=e;return t.jsx(r,{disabled:!s,container:i,children:t.jsx(Ke,{padding:a,children:t.jsx(Xe,{ref:n,...l,asChild:!1,children:o})})})})),Xo=h.forwardRef(((e,r)=>t.jsx(Je,{position:"absolute",top:"2",insetEnd:"2",...e,asChild:!0,children:t.jsx(lo,{size:"sm",ref:r})}))),Jo=Ye,Yo=Qe,Qo=Ze,Zo=et,es=tt,ts=rt,rs=nt,ns=ot,os=h.memo((({isSelected:e,latestMessage:r,onSelect:n,onDelete:o,isDeleteDisabled:s})=>t.jsxs(p,{...Vo.historyDrawer.historyItem,...e?Vo.historyDrawer.historyItemSelected:{},onClick:n,children:[t.jsxs(p,{...Vo.historyDrawer.historyHeader,children:[t.jsx(p,{...Vo.historyDrawer.timestamp,children:r.timestamp?Yt(new Date(r.timestamp),{addSuffix:!0}):"No messages"}),t.jsx(P,{onClick:o,disabled:s,...Vo.historyDrawer.deleteButton,children:t.jsx(st,{})})]}),r.content&&t.jsx(p,{...Vo.historyDrawer.messagePreview,children:r.content})]})));function ss({children:e}){const{open:r,setOpen:n,historyList:o,currentHistoryUid:s,fetchAndSetHistory:i,deleteHistory:a,getLatestMessageContent:l}=(()=>{const[e,t]=h.useState(!1),{historyList:r,currentHistoryUid:n,setCurrentHistoryUid:o,setHistoryList:s,messages:i,updateHistoryList:a}=In(),{sendMessage:l}=jr();return{open:e,setOpen:t,historyList:r,currentHistoryUid:n,fetchAndSetHistory:e=>{if(e&&e!==n){if(n&&i.length>0){const e=i[i.length-1];a(n,e)}o(e),l({type:"fetch-and-set-history",history_uid:e})}},deleteHistory:e=>{e!==n?(l({type:"delete-history",history_uid:e}),s(r.filter((t=>t.uid!==e)))):tr.create({title:"Cannot delete current chat history",type:"warning",duration:2e3})},getLatestMessageContent:e=>{if(e.uid===n&&i.length>0){const e=i[i.length-1];return{content:e.content,timestamp:e.timestamp}}return{content:e.latest_message?.content||"",timestamp:e.timestamp}}}})();return t.jsxs(Yo,{open:r,onOpenChange:e=>n(e.open),placement:"start",children:[t.jsx(ts,{}),t.jsx(Jo,{asChild:!0,children:e}),t.jsxs(Ko,{style:Vo.historyDrawer.drawer.content,children:[t.jsxs(Zo,{children:[t.jsx(rs,{style:Vo.historyDrawer.drawer.title,children:"Chat History List"}),t.jsx(Xo,{style:Vo.historyDrawer.drawer.closeButton})]}),t.jsx(es,{children:t.jsx(p,{...Vo.historyDrawer.listContainer,children:o.map((e=>t.jsx(os,{isSelected:s===e.uid,latestMessage:l(e),onSelect:()=>i(e.uid),onDelete:t=>{t.stopPropagation(),a(e.uid)},isDeleteDisabled:s===e.uid},e.uid)))})}),t.jsx(Qo,{children:t.jsx(ns,{asChild:!0,children:t.jsx(P,{...Vo.historyDrawer.drawer.actionButton,children:"Close"})})})]})]})}os.displayName="HistoryItem";const is=h.forwardRef((function(e,r){return t.jsx(it,{copied:t.jsx(at,{}),...e,ref:r,children:t.jsx(lt,{})})})),as=h.forwardRef((function(e,r){return t.jsx(it,{copied:"Copied",...e,ref:r,children:"Copy"})}));h.forwardRef((function(e,r){return t.jsx(ct,{textStyle:"sm",fontWeight:"medium",display:"inline-block",mb:"1",...e,ref:r})}));const ls=h.forwardRef((function(e,r){return t.jsx(dt,{asChild:!0,children:t.jsxs(P,{ref:r,size:"sm",variant:"surface",...e,children:[t.jsx(is,{}),t.jsx(as,{})]})})}));h.forwardRef((function(e,r){return t.jsx(dt,{asChild:!0,children:t.jsxs(P,{unstyled:!0,variant:"plain",size:"xs",display:"inline-flex",alignItems:"center",gap:"2",ref:r,...e,children:[t.jsx(ut,{}),t.jsx(as,{})]})})})),h.forwardRef((function(e,r){return t.jsx(dt,{asChild:!0,children:t.jsxs(b,{ref:r,size:"xs",variant:"subtle",...e,children:[t.jsx(is,{}),t.jsx(as,{srOnly:!0})]})})})),h.forwardRef((function(e,r){return t.jsx(ht,{asChild:!0,children:t.jsx(T,{ref:r,...e})})}));const cs=gt,ds=h.createContext(null);function us({children:e}){const[r,n]=h.useState(""),[o,s]=h.useState([]),[i,a]=h.useState(!1),l=h.useMemo((()=>o.includes(r)?[r,...o.filter((e=>e!==r))]:o),[o,r]);return t.jsx(ds.Provider,{value:{selfUid:r,groupMembers:o,isOwner:i,setSelfUid:n,setGroupMembers:s,setIsOwner:a,sortedGroupMembers:l,resetGroupState:()=>{s([]),a(!1)}},children:e})}function hs(){const e=h.useContext(ds);if(!e)throw new Error("useGroup must be used within a GroupProvider");return e}function gs({children:e}){const{selfUid:r,sortedGroupMembers:n,isOwner:o}=hs(),{isOpen:s,setIsOpen:i,inviteUid:a,setInviteUid:l,handleInvite:c,handleRemove:d,handleLeaveGroup:u,requestGroupInfo:g}=(()=>{const[e,t]=h.useState(!1),[r,n]=h.useState(""),{sendMessage:o}=jr(),s=h.useCallback((()=>{o({type:"request-group-info"})}),[o]),i=h.useCallback((async()=>{r.trim()?(o({type:"add-client-to-group",invitee_uid:r.trim()}),n(""),setTimeout(s,100)):tr.create({title:"Please enter a valid UUID",type:"error",duration:2e3})}),[r,o,s]),a=h.useCallback((e=>{o({type:"remove-client-from-group",target_uid:e}),setTimeout(s,100)}),[o,s]),l=h.useCallback((e=>{o({type:"remove-client-from-group",target_uid:e}),setTimeout(s,100)}),[o,s]);return{isOpen:e,setIsOpen:t,inviteUid:r,setInviteUid:n,handleInvite:i,handleRemove:a,handleLeaveGroup:l,requestGroupInfo:s}})();return t.jsxs(Yo,{open:s,onOpenChange:e=>{i(e.open),e.open&&g()},placement:"start",children:[t.jsx(ts,{}),t.jsx(Jo,{asChild:!0,children:e}),t.jsxs(Ko,{style:Vo.historyDrawer.drawer.content,children:[t.jsxs(Zo,{children:[t.jsx(rs,{style:Vo.historyDrawer.drawer.title,children:"Group Management"}),t.jsx(Xo,{style:Vo.historyDrawer.drawer.closeButton})]}),t.jsx(es,{children:t.jsxs(p,{...Vo.historyDrawer.listContainer,children:[t.jsxs(p,{...Vo.groupDrawer.section,children:[t.jsx(f,{...Vo.groupDrawer.sectionTitle,children:"Your UUID"}),t.jsxs(p,{...Vo.groupDrawer.memberItem,children:[t.jsx(f,{...Vo.groupDrawer.memberText,children:r}),t.jsx(cs,{value:r,children:t.jsx(ls,{...Vo.groupDrawer.clipboardButton,size:"sm"})})]})]}),t.jsxs(p,{...Vo.groupDrawer.section,children:[t.jsx(f,{...Vo.groupDrawer.sectionTitle,children:"Invite Member From Other Clients"}),t.jsxs(p,{...Vo.groupDrawer.inviteBox,children:[t.jsx(T,{value:a,onChange:e=>l(e.target.value),placeholder:"Enter member UUID",...Vo.groupDrawer.input}),t.jsx(P,{onClick:c,...Vo.groupDrawer.button,children:"Invite"})]})]}),t.jsxs(p,{...Vo.groupDrawer.section,children:[t.jsx(f,{...Vo.groupDrawer.sectionTitle,children:"Members"}),t.jsx(p,{...Vo.groupDrawer.memberList,children:n.map((e=>t.jsxs(p,{...Vo.groupDrawer.memberItem,children:[t.jsx(f,{...Vo.groupDrawer.memberText,children:e===r?`${e} (You)`:e}),(o&&e!==r||!o&&e===r)&&t.jsx(b,{"aria-label":e===r?"Leave group":"Remove member",onClick:()=>e===r?u(r):d(e),...Vo.groupDrawer.removeButton,size:"sm",title:e===r?"Leave group":"Remove member",children:e===r?"Leave":t.jsx(v,{})})]},e)))})]})]})}),t.jsx(Qo,{children:t.jsx(ns,{asChild:!0,children:t.jsx(P,{...Vo.historyDrawer.drawer.actionButton,children:"Close"})})})]})]})}const ps=({isOpen:e,onClose:r})=>{const[n,o]=h.useState("chat"),[s,i]=h.useState("general"),[a,l]=h.useState([]),[c,d]=h.useState([]),{aiState:u}=tn(),{createNewHistory:g}=(()=>{const{open:e,onOpen:t,onClose:r}=pt(),{sendMessage:n}=jr(),{interrupt:o}=Rn(),{currentHistoryUid:s,messages:i,updateHistoryList:a}=In();return{settingsOpen:e,onSettingsOpen:t,onSettingsClose:r,createNewHistory:()=>{if(s&&i.length>0){const e=i[i.length-1];a(s,e)}o(),n({type:"create-new-history"})}}})(),{inputValue:m,handleInputChange:x,handleKeyPress:w,handleCompositionStart:y,handleCompositionEnd:j,handleInterrupt:C,handleMicToggle:S,micOn:A}=(()=>{const{inputText:e,setInputText:t,handleKeyPress:r,handleCompositionStart:n,handleCompositionEnd:o}=Nn(),{interrupt:s}=Rn(),{startMic:i,autoStartMicOn:a}=dn(),{handleMicToggle:l,micOn:c}=un(),{setAiState:d,aiState:u}=tn(),{sendTriggerSignal:h}=So(),{settings:g}=Mo();return{inputValue:e,handleInputChange:e=>{t({target:{value:e.target.value}}),d(Qr.WAITING)},handleKeyPress:e=>{r(e)},handleCompositionStart:n,handleCompositionEnd:o,handleInterrupt:()=>{u===Qr.THINKING_SPEAKING?(s(),a&&i()):g.allowButtonTrigger&&h(-1)},handleMicToggle:l,micOn:c}})();h.useEffect((()=>{const t=t=>{"Escape"===t.key&&e&&r()};return e&&document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}}),[e,r]);const M=h.useCallback((e=>(l((t=>[...t,e])),()=>{l((t=>t.filter((t=>t!==e))))})),[]),I=h.useCallback((e=>(d((t=>[...t,e])),()=>{d((t=>t.filter((t=>t!==e))))})),[]),R=h.useCallback((()=>{a.forEach((e=>e()))}),[a]),T=h.useCallback((()=>{c.forEach((e=>e()))}),[c]);return e?t.jsx(p,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",bg:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(10px)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",children:t.jsxs(p,{bg:"white",borderRadius:"xl",width:"90vw",height:"90vh",maxWidth:"1200px",border:"1px solid",borderColor:"gray.300",overflow:"hidden",position:"relative",boxShadow:"2xl",children:[t.jsxs(E,{p:"4",bg:"gray.50",align:"center",justify:"space-between",borderBottom:"1px solid",borderColor:"gray.200",children:[t.jsx(Le,{size:"lg",color:"gray.800",children:"⚙️ コントロールパネル"}),t.jsxs(me,{gap:2,children:[t.jsxs(f,{fontSize:"xs",color:"gray.700",children:[t.jsx(mt,{children:"Esc"})," 閉じる"]}),t.jsx(b,{size:"sm",variant:"ghost",onClick:r,color:"gray.700",_hover:{color:"gray.800"},children:t.jsx(v,{})})]})]}),t.jsxs(ft,{templateColumns:"200px 1fr",h:"calc(100% - 80px)",children:[t.jsx(p,{bg:"gray.100",p:"4",borderRight:"1px solid",borderColor:"gray.200",children:t.jsxs(k,{gap:2,align:"stretch",children:[t.jsx(P,{variant:"chat"===n?"solid":"ghost",colorPalette:"blue",onClick:()=>o("chat"),justifyContent:"flex-start",children:t.jsxs(me,{gap:2,children:[t.jsx(xt,{}),t.jsx(f,{children:"💬 チャット履歴"})]})}),t.jsx(P,{variant:"settings"===n?"solid":"ghost",colorPalette:"blue",onClick:()=>o("settings"),justifyContent:"flex-start",children:t.jsxs(me,{gap:2,children:[t.jsx(bt,{}),t.jsx(f,{children:"⚙️ 設定"})]})}),t.jsx(P,{variant:"controls"===n?"solid":"ghost",colorPalette:"blue",onClick:()=>o("controls"),justifyContent:"flex-start",children:t.jsxs(me,{gap:2,children:[t.jsx(wt,{}),t.jsx(f,{children:"🎙️ 制御・状態"})]})})]})}),t.jsxs(p,{p:"4",overflow:"auto",children:["chat"===n&&t.jsxs(k,{gap:4,align:"stretch",h:"full",children:[t.jsxs(me,{gap:2,children:[t.jsx(P,{onClick:g,colorPalette:"green",children:"📝 新しい会話"}),t.jsx(ss,{children:t.jsx(P,{colorPalette:"blue",children:t.jsxs(me,{gap:1,children:[t.jsx(vt,{}),t.jsx(f,{children:"📜 履歴記録"})]})})}),t.jsx(gs,{children:t.jsx(P,{colorPalette:"purple",children:t.jsxs(me,{gap:1,children:[t.jsx(yt,{}),t.jsx(f,{children:"👥 グループ管理"})]})})})]}),t.jsx(p,{flex:"1",border:"1px solid",borderColor:"gray.200",borderRadius:"md",bg:"white",children:t.jsx(qo,{})})]}),"settings"===n&&t.jsxs(jt,{value:s,onValueChange:e=>i(e.value),h:"full",children:[t.jsxs(Ct,{children:[t.jsx(St,{value:"general",children:"🔧 一般設定"}),t.jsx(St,{value:"live2d",children:"🎭 Live2D"}),t.jsx(St,{value:"asr",children:"🎤 音声認識"}),t.jsx(St,{value:"tts",children:"🔊 音声合成"}),t.jsx(St,{value:"agent",children:"🤖 エージェント"}),t.jsx(St,{value:"media",children:"🎬 メディア"}),t.jsx(St,{value:"about",children:"ℹ️ 情報"})]}),t.jsxs(kt,{children:[t.jsx(Et,{value:"general",children:t.jsx(vo,{onSave:M,onCancel:I})}),t.jsx(Et,{value:"live2d",children:t.jsx(yo,{onSave:M,onCancel:I})}),t.jsx(Et,{value:"asr",children:t.jsx(jo,{onSave:M,onCancel:I})}),t.jsx(Et,{value:"tts",children:t.jsx(Co,{})}),t.jsx(Et,{value:"agent",children:t.jsx(Io,{onSave:M,onCancel:I})}),t.jsx(Et,{value:"media",children:t.jsx(Uo,{onSave:M,onCancel:I})}),t.jsx(Et,{value:"about",children:t.jsx(_o,{})})]}),t.jsxs(me,{mt:"4",justify:"flex-end",children:[t.jsx(P,{colorPalette:"red",onClick:T,children:"キャンセル"}),t.jsx(P,{colorPalette:"blue",onClick:R,children:"保存"})]})]}),"controls"===n&&t.jsxs(k,{gap:6,align:"stretch",children:[t.jsxs(p,{bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",p:"4",children:[t.jsx(Le,{size:"md",mb:"3",color:"gray.800",children:"🤖 AI状態"}),t.jsxs(me,{gap:4,children:[t.jsx(p,{w:"12px",h:"12px",bg:(()=>{switch(u){case"idle":default:return"gray.500";case"listening":return"blue.500";case"thinking-speaking":return"yellow.500";case"interrupted":return"red.500";case"loading":return"purple.500";case"waiting":return"orange.500"}})(),borderRadius:"full"}),t.jsx(f,{fontSize:"lg",fontWeight:"bold",color:"gray.700",children:(()=>{switch(u){case"idle":case"waiting":return"待機中";case"listening":return"聞き取り中";case"thinking-speaking":return"考え中・話し中";case"interrupted":return"中断";case"loading":return"読み込み中";default:return"不明な状態"}})()})]})]}),t.jsxs(p,{bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",p:"4",children:[t.jsx(Le,{size:"md",mb:"3",color:"gray.800",children:"🎙️ 音声制御"}),t.jsxs(me,{gap:4,children:[t.jsx(b,{size:"lg",bg:A?"green.500":"red.500",_hover:{bg:A?"green.600":"red.600"},onClick:S,color:"white",children:A?t.jsx(At,{}):t.jsx(Mt,{})}),t.jsxs(f,{color:"gray.700",children:["マイク：",A?"オン":"オフ"]}),t.jsx(b,{size:"lg",bg:"yellow.500",_hover:{bg:"yellow.600"},onClick:C,color:"white",children:t.jsx(It,{})}),t.jsx(f,{color:"gray.700",children:"中断/トリガー"})]})]}),t.jsxs(p,{bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",p:"4",children:[t.jsx(Le,{size:"md",mb:"3",color:"gray.800",children:"💬 テキスト入力"}),t.jsx(ro,{children:t.jsxs(p,{position:"relative",width:"100%",children:[t.jsx(b,{position:"absolute",left:"2",top:"2",size:"sm",variant:"ghost",color:"whiteAlpha.700",_hover:{color:"white"},zIndex:1,children:t.jsx(Rt,{})}),t.jsx(Tt,{value:m,onChange:x,onKeyDown:w,onCompositionStart:y,onCompositionEnd:j,placeholder:"メッセージを入力...",pl:"12",minH:"120px",bg:"gray.50",borderColor:"gray.300",color:"gray.800",_focus:{borderColor:"blue.500",bg:"white"}})]})})]})]})]})]})]})}):null},ms=(e,t,r)=>{const n=h.useCallback((()=>{console.log("Toggle fullscreen requested");if("undefined"!=typeof window&&window.api)try{return console.log("Calling Electron toggleFullscreen API"),void window.api.toggleFullscreen()}catch(n){console.error("Error calling Electron toggleFullscreen:",n)}const e=document,t=document.documentElement,r=e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement;try{if(r){const t=document.exitFullscreen||e.webkitExitFullscreen||e.mozCancelFullScreen||e.msExitFullscreen;t&&t.call(document)}else{const e=t.requestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullscreen;e&&e.call(t,{navigationUI:"hide"}).catch?.((()=>{}))}}catch(o){console.error("DOM fullscreen toggle failed:",o)}}),[]),o={"ctrl+ ":e,"ctrl+m":e,f11:n,"ctrl+g":n};r&&(o.escape=t),((e,t=!0)=>{const r=h.useCallback((r=>{if(!t)return;const n=[];r.ctrlKey&&n.push("ctrl"),r.altKey&&n.push("alt"),r.shiftKey&&n.push("shift"),r.metaKey&&n.push("meta");const o=r.key.toLowerCase(),s=n.length>0?`${n.join("+")}+${o}`:o;console.log(`Key pressed: ${r.key}, shortcutKey: ${s}, available shortcuts:`,Object.keys(e));const i=e[s];i&&(console.log(`Executing handler for: ${s}`),r.preventDefault(),r.stopPropagation(),i())}),[e,t]);h.useEffect((()=>{if(t)return document.addEventListener("keydown",r),()=>{document.removeEventListener("keydown",r)}}),[r,t])})(o,!0)},fs=h.createContext(void 0),xs=()=>{const e=h.useContext(fs);if(!e)throw new Error("useLaundry must be used within a LaundryProvider");return e},bs=({children:e})=>{const[r,n]=h.useState(!1),[o,s]=h.useState(null),[i,a]=h.useState(""),[l,c]=h.useState(!1),[d,u]=h.useState([]),[g,p]=h.useState(!1),[m,f]=h.useState(6e4),[x,b]=h.useState(!0),[w,v]=h.useState(3e3),y={isLaundryMode:r,setIsLaundryMode:n,currentVideo:o,videoTitle:i,isVideoPlaying:l,setCurrentVideo:(e,t="使用教程")=>{s(e),a(t),c(!!e)},availableMachines:d,setAvailableMachines:u,isIdle:g,setIsIdle:p,idleTimeout:m,setIdleTimeout:f,autoCloseEnabled:x,setAutoCloseEnabled:b,autoCloseDelay:w,setAutoCloseDelay:v};return t.jsx(fs.Provider,{value:y,children:e})},ws=({src:e,title:r="视频教程",autoPlay:n=!0,autoClose:o=!0,onClose:s,onEnded:i})=>{const a=h.useRef(null),[l,c]=h.useState(!1),[d,u]=h.useState(!1),[g,m]=h.useState(!0),[f,x]=h.useState(!0);h.useEffect((()=>{const t=a.current;if(!t)return;console.log("VideoPlayer: Setting up video with src:",e);const r=()=>{console.log("VideoPlayer: Video loaded successfully"),n&&(t.play().catch((e=>{console.error("VideoPlayer: Autoplay failed:",e)})),c(!0))},l=()=>{console.log("VideoPlayer: Video started playing"),c(!0)},d=()=>{console.log("VideoPlayer: Video paused"),c(!1)},u=()=>{console.log("VideoPlayer: Video ended"),c(!1),i&&i(),o&&setTimeout((()=>{s&&s()}),3e3)},h=e=>{console.error("VideoPlayer: Video error occurred:",e),console.error("VideoPlayer: Video error details:",t.error),console.error("VideoPlayer: Current src:",t.src)},g=()=>{console.log("VideoPlayer: Load start")},p=()=>{console.log("VideoPlayer: Can play")};return t.addEventListener("loadstart",g),t.addEventListener("loadeddata",r),t.addEventListener("canplay",p),t.addEventListener("play",l),t.addEventListener("pause",d),t.addEventListener("ended",u),t.addEventListener("error",h),()=>{t.removeEventListener("loadstart",g),t.removeEventListener("loadeddata",r),t.removeEventListener("canplay",p),t.removeEventListener("play",l),t.removeEventListener("pause",d),t.removeEventListener("ended",u),t.removeEventListener("error",h)}}),[e,n,o,s,i]);const w=()=>{const e=a.current;e&&(l?e.pause():e.play().catch((e=>{console.error("VideoPlayer: Play failed:",e)})))},y=()=>{s&&s()};return h.useEffect((()=>{let e;const t=()=>{m(!0),clearTimeout(e),e=setTimeout((()=>{l&&m(!1)}),3e3)},r=()=>t(),n=()=>{l&&m(!1)};return f&&(document.addEventListener("mousemove",r),document.addEventListener("mouseleave",n),t()),()=>{clearTimeout(e),document.removeEventListener("mousemove",r),document.removeEventListener("mouseleave",n)}}),[l,f]),t.jsx(p,{position:"fixed",top:"0",left:"0",width:"100vw",height:"100vh",bg:"black",zIndex:"9999",display:"flex",alignItems:"center",justifyContent:"center",children:t.jsxs(p,{position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",children:[t.jsx("video",{ref:a,src:e,style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"},controls:!1,playsInline:!0}),g&&t.jsxs(p,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",pointerEvents:"none",children:[t.jsxs(p,{position:"absolute",top:"0",left:"0",right:"0",height:"60px",bg:"linear-gradient(to bottom, rgba(0,0,0,0.7), transparent)",display:"flex",alignItems:"center",justifyContent:"space-between",px:"20px",pointerEvents:"auto",children:[t.jsx(p,{color:"white",fontSize:"lg",fontWeight:"bold",children:r}),t.jsx(b,{"aria-label":"关闭",icon:t.jsx(v,{}),variant:"ghost",colorScheme:"whiteAlpha",size:"lg",onClick:y})]}),!l&&t.jsx(p,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",children:t.jsx(b,{"aria-label":"播放",icon:t.jsx(Pt,{}),size:"xl",variant:"solid",colorScheme:"whiteAlpha",bg:"rgba(255,255,255,0.9)",color:"black",fontSize:"60px",width:"120px",height:"120px",borderRadius:"50%",onClick:w})}),t.jsx(p,{position:"absolute",bottom:"0",left:"0",right:"0",height:"80px",bg:"linear-gradient(to top, rgba(0,0,0,0.7), transparent)",display:"flex",alignItems:"center",justifyContent:"center",px:"20px",pointerEvents:"auto",children:t.jsxs(p,{display:"flex",alignItems:"center",gap:"4",children:[t.jsx(b,{"aria-label":l?"暂停":"播放",icon:l?t.jsx(Dt,{}):t.jsx(Pt,{}),variant:"ghost",colorScheme:"whiteAlpha",size:"lg",onClick:w}),t.jsx(b,{"aria-label":d?"取消静音":"静音",icon:d?t.jsx(Lt,{}):t.jsx(zt,{}),variant:"ghost",colorScheme:"whiteAlpha",size:"lg",onClick:()=>{const e=a.current;e&&(e.muted=!e.muted,u(e.muted))}}),t.jsx(P,{variant:"solid",colorScheme:"blue",size:"md",onClick:y,ml:"4",children:"关闭视频"})]})})]}),t.jsx(p,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",cursor:"pointer",onClick:w,pointerEvents:g?"none":"auto"})]})})},vs=h.createContext(void 0),ys=({children:e})=>{const[r,n]=h.useState(!0),[o,s]=h.useState(null);return t.jsx(vs.Provider,{value:{showAdvertisements:r,setShowAdvertisements:n,currentAdvertisement:o,setCurrentAdvertisement:s},children:e})},js=()=>{const e=h.useContext(vs);if(!e)throw new Error("useAdvertisement must be used within an AdvertisementProvider");return e};const Cs=new class{audioContext=null;analyser=null;source=null;dataArray=null;monitoringInterval=null;callbacks=new Set;isMonitoring=!1;constructor(){this.initializeAudioContext()}async initializeAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),console.log("🎵 广告音频监听器初始化成功")}catch(e){console.error("❌ 广告音频监听器初始化失败:",e)}}startMonitoring(e){if(this.audioContext&&this.analyser){this.isMonitoring&&(console.log("🔄 停止之前的音频监听..."),this.stopMonitoring());try{const t=e.__audioSource;t?(console.log("♻️ 重用现有的音频源连接"),this.source=t):(this.source=this.audioContext.createMediaElementSource(e),e.__audioSource=this.source),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.isMonitoring=!0,this.startAnalysis(),console.log("🎤 开始监听广告音频")}catch(t){console.error("❌ 开始监听失败:",t),this.isMonitoring=!1,this.source=null}}}stopMonitoring(){if(this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.source){try{this.source.disconnect(),console.log("🔌 音频源已断开连接")}catch(e){console.warn("断开音频源连接时出错:",e)}this.source=null}this.isMonitoring=!1,console.log("🔇 停止监听广告音频")}addCallback(e){this.callbacks.add(e)}removeCallback(e){this.callbacks.delete(e)}startAnalysis(){this.monitoringInterval=window.setInterval((()=>{this.analyzeAudio()}),100)}analyzeAudio(){if(!this.analyser||!this.dataArray)return;this.analyser.getByteFrequencyData(this.dataArray);const e=this.calculateAverage(this.dataArray),t={isPlaying:e>10,volume:e/255,averageAmplitude:e,peakAmplitude:Math.max(...this.dataArray)};this.callbacks.forEach((e=>{try{e(t)}catch(r){console.error("音频回调执行失败:",r)}}))}calculateAverage(e){return e.reduce(((e,t)=>e+t),0)/e.length}getAudioContextState(){return this.audioContext?.state||null}async resumeAudioContext(){"suspended"===this.audioContext?.state&&(await this.audioContext.resume(),console.log("🔊 音频上下文已恢复"))}},Ss=h.memo((({isVisible:e,onRequestAdvertisements:r,enableAudioWithVAD:n=!0,defaultAudioEnabled:o=!0})=>{const[s,i]=h.useState([]),[a,l]=h.useState(0),[c,d]=h.useState(!0),[u,g]=h.useState({isPlaying:!1,volume:0,averageAmplitude:0,peakAmplitude:0}),[p,m]=h.useState(!1),[f,x]=h.useState(o),b=h.useRef(null),w=h.useRef(null),{sendMessage:v,wsState:y,baseUrl:j}=jr(),[C,S]=h.useState(!1);h.useEffect((()=>{const e=ur.onMessage((e=>{if("full-text"===e.type&&"Connection established"===e.text&&(console.log("🔗 AdCarousel: WebSocket连接已建立"),S(!0)),"mcp-tool-response"===e.type&&("get_advertisement_playlist"===e.tool_name||"refresh_advertisements"===e.tool_name)){if(console.log("✅ 收到MCP工具响应:",e),e.error)return console.error("❌ AdCarousel: MCP工具调用失败:",e.error),void d(!1);try{if(e.result&&Array.isArray(e.result)&&e.result.length>0){const t=e.result[0];if(t.is_error)return console.error("❌ AdCarousel: 工具执行失败:",t.content),i([]),void d(!1);const r=t.content;console.log("📋 解析工具响应数据:",r);const n="string"==typeof r?JSON.parse(r):r;if("refresh_advertisements"===e.tool_name)return void console.log("🔄 广告刷新完成:",n.message||"刷新成功");if(n&&n.playlist&&Array.isArray(n.playlist)){const e=n.playlist.map(((e,t)=>({id:`ad_${t+1}`,name:e.name||e.filename?.replace(/\.[^/.]+$/,"")||`Advertisement ${t+1}`,filename:e.filename,url_path:e.url_path,size_mb:e.size_mb||0,format:e.format||".mp4"})));if(i(e),a>=e.length){const t=Math.max(0,e.length-1);console.log(`🔧 AdCarousel: 广告列表更新，索引调整 ${a} -> ${t}`),l(t)}console.log(`🎬 AdCarousel: 成功加载了 ${e.length} 个广告`)}else console.warn("⚠️ AdCarousel: 广告播放列表为空"),i([]),l(0)}else console.warn("⚠️ AdCarousel: MCP响应格式异常 - result为空或非数组"),i([]),l(0)}catch(t){console.error("❌ AdCarousel: 解析广告列表响应失败:",t),i([]),l(0)}d(!1)}}));return()=>e.unsubscribe()}),[]);const k=h.useCallback((async()=>{try{console.log("🎬 AdCarousel: 请求广告列表...");const e={type:"mcp-tool-call",tool_name:"refresh_advertisements",arguments:{}};console.log("🔄 发送刷新请求:",e),v(e),setTimeout((()=>{const e={type:"mcp-tool-call",tool_name:"get_advertisement_playlist",arguments:{}};console.log("📡 发送广告列表请求:",e),v(e)}),500),setTimeout((()=>{c&&(console.error("❌ 广告列表请求超时"),d(!1))}),8e3)}catch(e){console.error("❌ 广告列表获取失败:",e),d(!1)}}),[v,c]);h.useCallback((()=>{s.length>1?l((e=>(e+1)%s.length)):1===s.length&&l(0)}),[s.length]),h.useEffect((()=>{if(0===s.length)l(0);else if(a>=s.length){const e=s.length-1;console.log(`🔧 AdCarousel: 索引越界修正 ${a} -> ${e}`),l(e)}}),[s.length,a]),h.useEffect((()=>{e&&C&&(0===s.length?(console.log("🚀 AdCarousel: 连接就绪，开始获取广告列表..."),setTimeout((()=>{k()}),500)):p&&(console.log("🔄 AdCarousel: 处理待处理的刷新请求..."),k(),m(!1)))}),[e,C,s.length,p]),h.useEffect((()=>{const t=t=>{const{action:r,filename:n,trigger:o}=t.detail||{};console.log(`🔔 AdCarousel: 收到广告变化通知 - ${r}: ${n||"(系统触发)"}`),o&&console.log(`📝 触发原因: ${o}`),"upload"===r||"delete"===r?e&&C?(console.log("⚡ AdCarousel: 检测到文件变化，立即刷新广告列表..."),k()):(console.log("⏸️ AdCarousel: 文件变化已记录，设置待处理刷新标志"),m(!0)):"refresh_on_show"===r&&console.log("🚫 AdCarousel: 忽略重新显示时的刷新请求，避免播放中断")};return window.addEventListener("advertisementListChanged",t),()=>{window.removeEventListener("advertisementListChanged",t)}}),[e,C,k]),h.useEffect((()=>(w.current&&(clearInterval(w.current),w.current=null),()=>{w.current&&clearInterval(w.current)})),[e,s.length,a]);const E=h.useMemo((()=>s[a]),[s,a]);h.useEffect((()=>{const t=b.current;if(!t||!e||0===s.length)return;if(!E)return;console.log(`▶️ AdCarousel: 准备加载广告 ${E.name} (索引: ${a})`);let r=E.url_path;r.startsWith("/")&&(r=j+r),console.log(`📺 视频URL: ${r}`);const o=()=>{console.log("🎬 AdCarousel: 视频可以播放，开始播放"),f?(console.log("🎵 启用有声广告模式"),n&&(console.log("+ 智能VAD"),Cs.startMonitoring(t)),t.muted=!1,t.play().then((()=>{console.log("✅ 有声广告播放成功"),n&&v({type:"adaptive-vad-control",action:"start",volume:.5})})).catch((e=>{console.warn("有声播放失败，fallback到静音:",e),t.muted=!0,t.play().catch((e=>{console.error("静音播放也失败:",e)}))}))):(console.log("🔇 使用静音广告模式"),t.muted=!0,t.play().catch((e=>{console.error("静音广告视频播放失败:",e)})))},i=()=>{console.log("✅ AdCarousel: 视频数据加载完成")},l=()=>{console.error("❌ AdCarousel: 视频加载出错")};return t.src=r,t.load(),t.addEventListener("canplay",o,{once:!0}),t.addEventListener("loadeddata",i,{once:!0}),t.addEventListener("error",l,{once:!0}),()=>{t.removeEventListener("canplay",o),t.removeEventListener("loadeddata",i),t.removeEventListener("error",l)}}),[e,a,s,f,n,v,j]),h.useEffect((()=>{if(f&&n){const e=e=>{g(e),e.isPlaying!==u.isPlaying&&v({type:"adaptive-vad-control",action:e.isPlaying?"adjust":"reset",volume:e.volume})};return Cs.addCallback(e),()=>{Cs.removeCallback(e)}}}),[f,n,u.isPlaying,v]),h.useEffect((()=>()=>{f&&n&&(Cs.stopMonitoring(),v({type:"adaptive-vad-control",action:"stop"}))}),[f,n,v]);const A=h.useCallback((()=>{if(console.log("📺 AdCarousel: 视频播放结束"),console.log(`📊 当前状态: 索引${a}/${s.length}, 可见:${e}`),f&&n&&Cs.stopMonitoring(),1===s.length){console.log("🔄 AdCarousel: 只有一个广告，重新播放");const e=b.current;e&&(e.currentTime=0,e.play().catch((e=>{console.error("重新播放广告失败:",e)})))}else{const e=(a+1)%s.length;0===e&&console.log("🔄 AdCarousel: 完成一轮播放，开始新的循环"),console.log(`➡️ AdCarousel: 切换到下一个广告 ${a} -> ${e}`),l(e)}}),[a,s.length,e,f,n]);return e?t.jsxs("div",{className:"ad-carousel-overlay",children:[c?t.jsxs("div",{className:"ad-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"広告コンテンツを読み込み中..."})]}):0===s.length?t.jsx("div",{className:"ad-empty",children:t.jsxs("div",{className:"empty-placeholder",children:[t.jsx("h2",{children:"🎬 広告カルーセルシステム"}),t.jsx("p",{children:"広告コンテンツがありません"}),t.jsx("p",{children:"ads/ フォルダに動画ファイルを追加してください"}),t.jsx("small",{children:"対応形式: MP4, AVI, MOV, WebM, MKV"})]})}):t.jsx("div",{className:"ad-player-container",children:t.jsx("video",{ref:b,className:"ad-video",crossOrigin:"anonymous",autoPlay:!0,loop:!1,onEnded:A,onError:e=>{const t=e.currentTarget;console.error("広告動画の読み込み失敗:",t.src,t.error)},onLoadStart:()=>console.log("📺 AdCarousel: 开始加载视频"),onCanPlay:()=>console.log("📺 AdCarousel: 视频可以播放"),onPlay:()=>console.log("▶️ AdCarousel: 视频开始播放"),onPause:()=>console.log("⏸️ AdCarousel: 视频暂停"),onTimeUpdate:e=>{const t=e.currentTarget,r=(t.currentTime/t.duration*100).toFixed(1);t.currentTime%5<.1&&console.log(`⏰ AdCarousel: 播放进度 ${r}% (${t.currentTime.toFixed(1)}s/${t.duration.toFixed(1)}s)`)},controls:!0,children:"您的浏览器不支持视频播放。"})}),t.jsx("style",{children:"\n        .ad-carousel-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100vw;\n          height: 100vh;\n          background: #000;\n          z-index: 9999;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n\n        .ad-loading {\n          text-align: center;\n          color: white;\n        }\n\n        .loading-spinner {\n          width: 50px;\n          height: 50px;\n          border: 3px solid rgba(255, 255, 255, 0.3);\n          border-top: 3px solid white;\n          border-radius: 50%;\n          animation: spin 1s linear infinite;\n          margin: 0 auto 20px;\n        }\n\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n\n        .ad-empty {\n          text-align: center;\n          color: white;\n          padding: 40px;\n        }\n\n        .empty-placeholder h2 {\n          margin-bottom: 20px;\n          font-size: 2em;\n        }\n\n        .empty-placeholder p {\n          margin: 10px 0;\n          font-size: 1.2em;\n        }\n\n        .empty-placeholder small {\n          opacity: 0.7;\n          font-size: 0.9em;\n        }\n\n        .ad-player-container {\n          position: relative;\n          width: 100%;\n          height: 100%;\n        }\n\n        .ad-video {\n          width: 100%;\n          height: 100%;\n          object-fit: cover;\n        }\n\n        /* ✅ 移除所有叠加层样式 - 实现纯净播放体验 */\n\n\n      "})]}):null}));class ks extends h.Component{constructor(e){super(e),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){console.error("🚨 React Error Boundary捕获到错误:",e),console.error("📍 错误详细信息:",t),this.setState({error:e,errorInfo:t}),this.props.onError&&this.props.onError(e,t),this.reportError(e,t)}reportError(e,t){const r={message:e.message,stack:e.stack,componentStack:t.componentStack,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,url:window.location.href};try{console.warn("📊 错误报告已记录:",r)}catch(n){console.error("❌ 错误报告发送失败:",n)}}handleReset=()=>{this.setState({hasError:!1,error:null,errorInfo:null})};handleRefresh=()=>{window.location.reload()};handleGoHome=()=>{window.location.href="/"};render(){return this.state.hasError?this.props.fallback?this.props.fallback:t.jsx(p,{minH:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bg:"gray.50",p:8,children:t.jsxs(k,{spacing:6,maxW:"md",textAlign:"center",children:[t.jsx(p,{color:"red.500",fontSize:"5xl",children:t.jsx(Ut,{})}),t.jsxs(k,{spacing:3,children:[t.jsx(Le,{size:"lg",color:"gray.800",children:"应用遇到了问题"}),t.jsx(f,{color:"gray.600",fontSize:"md",children:"很抱歉，应用发生了意外错误。请尝试以下解决方案："})]}),t.jsxs(me,{spacing:4,children:[t.jsx(P,{leftIcon:t.jsx(_t,{}),colorScheme:"blue",onClick:this.handleReset,size:"md",children:"重试"}),t.jsx(P,{leftIcon:t.jsx(_t,{}),variant:"outline",onClick:this.handleRefresh,size:"md",children:"刷新页面"}),t.jsx(P,{leftIcon:t.jsx($t,{}),variant:"ghost",onClick:this.handleGoHome,size:"md",children:"返回主页"})]}),!1]})}):this.props.children}}const Es=h.memo((({children:e})=>{const[r,n]=h.useState("CLOSED"),[o,s]=ar("wsUrl",Cr),[i,a]=ar("baseUrl",Sr),{aiState:l,setAiState:c,backendSynthComplete:d,setBackendSynthComplete:u}=tn(),{setModelInfo:g}=Vr(),{setSubtitleText:p}=Pr(),{clearResponse:m,setForceNewMessage:f}=In(),{addAudioTask:x}=Tn(),b=Ar(),{confUid:w,setConfName:v,setConfUid:y,setConfigFiles:j}=Fr(),[C,S]=h.useState(void 0),{setSelfUid:k,setGroupMembers:E,setIsOwner:A}=hs(),{startMic:M,stopMic:I,autoStartMicOnConvEnd:R}=dn(),T=h.useRef(R),{interrupt:P}=Rn(),{setCurrentVideo:D,setAvailableMachines:L,isLaundryMode:z,setIsLaundryMode:U}=xs(),{setShowAdvertisements:_}=js();h.useEffect((()=>{T.current=R}),[R]),h.useEffect((()=>{C&&(g(C),S(void 0))}),[C,g,w]);const{setCurrentHistoryUid:$,setMessages:O,setHistoryList:F,appendHumanMessage:B}=In(),N=h.useCallback((e=>{switch(e){case"start-mic":console.log("Starting microphone..."),M();break;case"stop-mic":console.log("Stopping microphone..."),I();break;case"conversation-chain-start":c("thinking-speaking"),p("考え中..."),Kr.clearQueue(),m();break;case"conversation-chain-end":Kr.addTask((()=>new Promise((e=>{c((e=>"thinking-speaking"===e?(T.current&&M(),"idle"):e)),e()}))));break;default:console.warn("Unknown control command:",e)}}),[c,m,f,M,I]),W=h.useCallback((e=>{switch(console.log("Received message from server:",e),e.type){case"control":e.text&&N(e.text);break;case"set-model-and-conf":if(c("loading"),e.conf_name&&v(e.conf_name),e.conf_uid&&(y(e.conf_uid),console.log("confUid",e.conf_uid)),e.client_uid&&k(e.client_uid),S(e.model_info),e.model_info&&!e.model_info.url.startsWith("http")){const t=i+e.model_info.url;e.model_info.url=t}c("idle");break;case"full-text":e.text&&p(e.text);break;case"config-files":e.configs&&j(e.configs);break;case"config-switched":c("idle"),p("新しいキャラクターが読み込まれました"),tr.create({title:"Character switched",type:"success",duration:2e3}),ur.sendMessage({type:"fetch-history-list"}),ur.sendMessage({type:"create-new-history"});break;case"background-files":e.files&&b?.setBackgroundFiles(e.files);break;case"laundry-video-response":if(e.video_path){z||U(!0);const t=e.machine_id?`${e.machine_id}号洗衣机使用教程`:"洗衣机使用教程";let r=e.video_path;r.startsWith("/")&&(r=i+r),console.log(`🎬 洗衣机视频URL: ${r}`),console.log("🔇 静默模式: "+(e.silent_mode?"是":"否")),e.silent_mode&&e.response_text&&console.log(`🔇 静默模式已启用，跳过语音播放: "${e.response_text}"`),D(r,t)}break;case"laundry-machines-list":z&&e.machines&&L(e.machines);break;case"wake-word-state":const{action:t,matched_word:r,language:n,current_state:o,stats:s,advertisement_control:a}=e;if("wake_up"===t?console.log(`✨ ウェイクワード検出: "${r}" (${n}) - 会話開始`):"sleep"===t?console.log(`💤 終了ワード検出: "${r}" (${n}) - 会話終了`):"ignored"===t&&console.log(`🔇 非アクティブ状態、入力無視: "${r}"`),a){const{should_show_ads:e,control_action:t,trigger_reason:r}=a;"start_ads"===t?(console.log(`🎬 広告システム: 広告カルーセル再生開始 (理由: ${r})`),_(!0),console.log("✅ 广告重新显示，无需刷新避免播放中断")):"stop_ads"===t&&(console.log(`🛑 広告システム: 広告再生停止 (理由: ${r})`),_(!1)),console.log("📊 広告表示状態: "+(e?"表示":"非表示"))}break;case"audio":"interrupted"===l||"listening"===l?console.log("Audio playback intercepted. Sentence:",e.display_text?.text):(console.log("actions",e.actions),x({audioBase64:e.audio||"",volumes:e.volumes||[],sliceLength:e.slice_length||0,displayText:e.display_text||null,expressions:e.actions?.expressions||null,forwarded:e.forwarded||!1}));break;case"history-data":e.messages&&O(e.messages),tr.create({title:"History loaded",type:"success",duration:2e3});break;case"new-history-created":if(c("idle"),p("新しい会話が始まりました"),e.history_uid){$(e.history_uid),O([]);const t={uid:e.history_uid,latest_message:null,timestamp:(new Date).toISOString()};F((e=>[t,...e])),tr.create({title:"New chat history created",type:"success",duration:2e3})}break;case"history-deleted":tr.create({title:e.success?"History deleted successfully":"Failed to delete history",type:e.success?"success":"error",duration:2e3});break;case"history-list":e.histories&&(F(e.histories),e.histories.length>0&&$(e.histories[0].uid));break;case"user-input-transcription":console.log("user-input-transcription: ",e.text),e.text&&B(e.text);break;case"error":tr.create({title:e.message,type:"error",duration:2e3});break;case"group-update":console.log("Received group-update:",e.members),e.members&&E(e.members),void 0!==e.is_owner&&A(e.is_owner);break;case"group-operation-result":tr.create({title:e.message,type:e.success?"success":"error",duration:2e3});break;case"backend-synth-complete":u(!0);break;case"conversation-chain-end":Kr.hasTask()||c((e=>"thinking-speaking"===e?"idle":e));break;case"force-new-message":f(!0);break;case"interrupt-signal":P(!1);break;case"mcp-tool-response":console.log("📡 MCP工具响应已转发给相关组件:",e.tool_name);break;case"adaptive-vad-response":e.success?console.log(`✅ VAD控制操作 '${e.action}' 成功执行`):console.warn(`❌ VAD控制操作失败: ${e.error}`);break;default:console.warn("Unknown message type:",e.type)}}),[l,x,B,i,b,c,v,y,j,$,F,O,g,p,M,I,k,E,A,d,u,m]);h.useEffect((()=>{ur.connect(o)}),[o]),h.useEffect((()=>{const e=ur.onStateChange(n),t=ur.onMessage(W);return()=>{e.unsubscribe(),t.unsubscribe()}}),[o,W]);const H=h.useMemo((()=>({sendMessage:ur.sendMessage.bind(ur),wsState:r,reconnect:()=>ur.connect(o),wsUrl:o,setWsUrl:s,baseUrl:i,setBaseUrl:a})),[r,o,i]);return t.jsx(yr.Provider,{value:H,children:e})})),As=({children:e})=>t.jsx(ks,{onError:(e,t)=>{console.error("🚨 全局React错误:",e,t),cr.handleError({type:"unknown",message:e.message,originalError:e,context:"React Component Tree",timestamp:Date.now(),recoverable:!1})},children:t.jsxs(Ot,{value:Ft,children:[t.jsx(rr,{}),e]})}),Ms=({children:e})=>t.jsx(t.Fragment,{children:e}),Is=({children:e})=>t.jsx(bs,{children:t.jsx(ys,{children:e})}),Rs=({children:e})=>t.jsx(As,{children:t.jsx(Ms,{children:t.jsx(Is,{children:e})})}),Ts=({children:e})=>(console.warn("⚠️ 使用LegacyProviders，请尽快迁移到Zustand状态管理"),t.jsx(xn,{children:t.jsx(sr,{children:t.jsx(Jr,{children:t.jsx(Or,{children:t.jsx(Mn,{children:t.jsx(en,{children:t.jsx(Ao,{children:t.jsx(Hr,{children:t.jsx(Tr,{children:t.jsx(cn,{children:t.jsx(Er,{children:t.jsx(us,{children:t.jsx(Es,{children:e})})})})})})})})})})})})})),Ps=({children:e,useLegacy:r=!1})=>r?t.jsx(As,{children:t.jsx(Is,{children:t.jsx(Ts,{children:e})})}):t.jsx(Rs,{children:e});function Ds(){const[e,r]=h.useState("window"),[n,o]=h.useState(!1),[s,i]=h.useState(!1),a=void 0!==window.api,{currentVideo:l,videoTitle:c,setCurrentVideo:d}=xs(),{showAdvertisements:u}=js(),{isAudioEnabled:g,isVADEnabled:m}=(()=>{const[e]=ar("advertisementAudioSettings",zo);return{settings:e,isAudioEnabled:"muted"!==e.audioMode,isVADEnabled:"audio_vad"===e.audioMode,audioMode:e.audioMode}})(),f=()=>o(!1);ms((()=>o(!0)),f,n),h.useEffect((()=>{if(a&&window.api?.onFullscreenChange){return window.api.onFullscreenChange((e=>{i(e)}))}}),[a]),h.useEffect((()=>{a&&window.electron.ipcRenderer.on("pre-mode-changed",((e,t)=>{requestAnimationFrame((()=>{requestAnimationFrame((()=>{window.electron.ipcRenderer.send("renderer-ready-for-mode-change",t)}))}))}))}),[a]),h.useEffect((()=>{a&&window.electron.ipcRenderer.on("mode-changed",((e,t)=>{r(t),requestAnimationFrame((()=>{requestAnimationFrame((()=>{window.electron.ipcRenderer.send("mode-change-rendered")}))}))}))}),[a]),h.useEffect((()=>{const e=()=>{const e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]);return t.jsxs(t.Fragment,{children:["window"===e?t.jsxs(t.Fragment,{children:[a&&!s&&t.jsx(Bn,{}),t.jsxs(p,{width:"100vw",height:s?"100vh":a?"calc(100vh - 30px)":"100vh",bg:"gray.900",color:"white",overflow:"hidden",position:"relative",children:[t.jsx(Dn,{}),t.jsx(ps,{isOpen:n,onClose:f})]})]}):t.jsxs(t.Fragment,{children:[t.jsx(Pn,{isPet:"pet"===e}),"pet"===e&&t.jsx(to,{isPet:"pet"===e})]}),l&&t.jsx(ws,{src:l,title:c,autoPlay:!0,autoClose:!0,onClose:()=>d(null),onEnded:()=>{console.log("视频播放完成")}}),t.jsx(Ss,{isVisible:u,enableAudioWithVAD:m,defaultAudioEnabled:g,onRequestAdvertisements:()=>{console.log("请求更多广告数据...")}})]})}function Ls(){return t.jsx(Ps,{useLegacy:!0,children:t.jsx(Ds,{})})}const zs=console.warn;console.warn=(...e)=>{"string"==typeof e[0]&&e[0].includes("onnxruntime")||zs.apply(console,e)},"undefined"!=typeof window&&Bt(document.getElementById("root")).render(t.jsx(Ls,{}));
